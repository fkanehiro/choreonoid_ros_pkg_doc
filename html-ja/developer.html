

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Information for developers &mdash; Choreonoid ROS Plugin 0.1.0 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="genindex.html"/>
        <link rel="search" title="検索" href="search.html"/>
    <link rel="top" title="Choreonoid ROS Plugin 0.1.0 ドキュメント" href="index.html"/>
        <link rel="prev" title="Choreonoid ROSプラグインチュートリアル" href="tutorial.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Choreonoid ROS Plugin
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">インストール</a></li>
<li class="toctree-l1"><a class="reference internal" href="manual.html">Choreonoid ROSプラグインマニュアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Choreonoid ROSプラグインチュートリアル</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Information for developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#choreonoid-ros-plguin">Choreonoid ROS plguin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#implement-a-controller">Implement a controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#derive-the-base-class">Derive the base class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implement-initialize">Implement initialize()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implement-control">Implement control()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#implement-a-other-than-controller">Implement a other than controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#decide-to-base-class">Decide to base class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implement-processing-of-initialize">Implement processing of initialize</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implement-processing-of-publish">Implement processing of publish</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#common-matters">Common matters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#if-you-adds-new-feature-in-this-plugin">If you adds new feature in this plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#definition-of-plugin-entry">Definition of plugin entry</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#others">Others</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#copy-a-header-file-not-installed">Copy a header file not installed</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-and-output-in-controlleritem-class">Input() and output() in ControllerItem class</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#porting-gazebo-ros-plguin">Porting Gazebo ROS plguin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initialization">Initialization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#porting-initialization-functions-of-gazebo-plugin">Porting initialization functions of Gazebo plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initial-potures-of-models">Initial potures of models</a></li>
<li class="toctree-l4"><a class="reference internal" href="#properties-in-the-urdf-or-xacro-files">Properties in the urdf or xacro files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#finalization">Finalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Implement control()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#porting-functions">Porting functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging-and-notifications-to-users">Logging and notifications to users</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#appendix">Appendix</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bodyrositem-h">BodyRosItem.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bodyrositem-cpp">BodyRosItem.cpp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worldrositem-h">WorldRosItem.h</a></li>
<li class="toctree-l3"><a class="reference internal" href="#worldrositem-cpp">WorldRosItem.cpp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rosbodyplugin-cpp">RosBodyPlugin.cpp</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cmakelists-txt">CMakeLists.txt</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Choreonoid ROS Plugin</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Information for developers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/developer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="information-for-developers">
<h1>Information for developers<a class="headerlink" href="#information-for-developers" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>本章では、Choreonoid ROS プラグイン、Gazebo ROS プラグインからの移植に関する内容を記載します。</p>
<p>本章は、C++ および CMake での開発経験、Choreonoid プラグインの実装方法、ROS API、Gazebo ROS packages について概ね理解している事が前提条件となります。</p>
<p>Choreonoid プラグインの実装方法、ROS API、Gazebo ROS packages の詳細については、以下の URL を参照してください。</p>
<ul>
<li><p class="first">Choreonoid - Plugin development:</p>
<p><a class="reference external" href="http://choreonoid.org/ja/manuals/latest/plugin-development/index.html">http://choreonoid.org/ja/manuals/latest/plugin-development/index.html</a></p>
</li>
<li><p class="first">ROS API:</p>
<p><a class="reference external" href="http://wiki.ros.org/APIs">http://wiki.ros.org/APIs</a></p>
<p><a class="reference external" href="http://docs.ros.org/api/roscpp/html">http://docs.ros.org/api/roscpp/html</a></p>
</li>
<li><p class="first">Gazebo ROS packages (source code):</p>
<p><a class="reference external" href="https://github.com/ros-simulation/gazebo_ros_pkgs.git">https://github.com/ros-simulation/gazebo_ros_pkgs.git</a></p>
</li>
<li><p class="first">Gazebo - Connect to ROS tutorial:</p>
<p><a class="reference external" href="http://gazebosim.org/tutorials?cat=connect_ros">http://gazebosim.org/tutorials?cat=connect_ros</a></p>
</li>
</ul>
<p>本章の説明は、特に断りが無い限り Choreonoid ROS プラグイン本体のソースコード (choreonoid_ros_pkg/choreonoid_plugins/src 以下) を元とした記載となります。</p>
<p>説明で使用するソースコードは、Appendix に全て省略の無い状態で載せています。
必要に応じて参照してください。</p>
<p>なお、説明はいずれも 2017/03/20 時点の内容に基づくものとなります。</p>
<div class="section" id="choreonoid-ros-plguin">
<h2>Choreonoid ROS plguin<a class="headerlink" href="#choreonoid-ros-plguin" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>この節では、Choreonoid ROS プラグインについて説明します。</p>
<p>既存の実装について説明することで、機能拡張を実施する際に必要な情報を提供する事および、類似のプラグインを実装する際の参考情報を提供する事を主旨としています。</p>
<p>なお、コントローラとコントローラに属さないものを、それぞれの項として記載しています。</p>
<p>これは、Choreonoid ROS プラグインが、ロボットに属する処理 (センサ処理や関節制御など) をコントローラ、シミュレーション環境に属する処理 (シミュレーションの制御やワールド内の情報提供など) をコントローラでないものとして実装している事によります。</p>
<div class="section" id="implement-a-controller">
<h3>Implement a controller<a class="headerlink" href="#implement-a-controller" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コントローラの実装について、Choreonoid ROS プラグインの BodyRosItem の実装を元に説明します。</p>
<p>BodyRosItem が提供する機能については、<a class="reference internal" href="manual.html#manual-ros-topics"><span class="std std-ref">ROSトピックス</span></a> の注釈を参照してください。</p>
<div class="section" id="derive-the-base-class">
<h4>Derive the base class<a class="headerlink" href="#derive-the-base-class" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Choreonoid フレームワーク上でコントローラを実装するためのクラスとして用意された ControllerItem クラスを基底クラスとします。</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">BodyRosItem.h - Class definition</span><a class="headerlink" href="#id7" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CNOID_EXPORT</span> <span class="nl">BodyRosItem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">ControllerItem</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">同じ用途を持つクラスとして、ControllerItem クラスとは別に SimpleControllerItem クラスも用意されていますが、Choreonoid ROS プラグインでは使用していないため、説明は割愛します。</p>
</div>
</div>
<div class="section" id="implement-initialize">
<h4>Implement initialize()<a class="headerlink" href="#implement-initialize" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="section" id="id1">
<h5>初回実行時のみの処理<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>初回実行時のみ必要な処理は static 関数として実装し、後述するプラグイン本体の初期化処理において呼び出すようにします。</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">BodyRosItem.h - Prototype definition of initialize()</span><a class="headerlink" href="#id8" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">public</span><span class="o">:</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::initialize()</span><a class="headerlink" href="#id9" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">;</span>
<span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ros</span><span class="o">::</span><span class="n">isInitialized</span><span class="p">())</span>
</span><span class="hll">    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;choreonoid&quot;</span><span class="p">);</span>
</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">registerClass</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;BodyRosItem&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">addCreationPanel</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span><span class="p">();</span>
</span>    <span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>15 行目および 16 行目は ROS の初期化処理です。</p>
<p>当該処理は、プロセス内で複数回実行すると問題が生じるため、ros::isInitialized で実行の確認を実施し、重複実行を防止します。</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">BodyRosItem.cpp - ROS initialization</span><a class="headerlink" href="#id10" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ros</span><span class="o">::</span><span class="n">isInitialized</span><span class="p">())</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;choreonoid&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>18 行目および 19 行目は、BodyRosItem を Choreonoid へ登録する処理です。</p>
<p>こちらも複数回実行すると問題が生じるため、重複実行を防止します。</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">BodyRosItem.cpp - Register BodyRosItem class</span><a class="headerlink" href="#id11" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">registerClass</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;BodyRosItem&quot;</span><span class="p">);</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">addCreationPanel</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id2">
<h5>シミュレーション開始時の処理<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>シミュレーション開始時に実行する必要がある処理は ControllerItem の start() 仮想関数を実装します。</p>
<p>start() はシミュレーションの開始と同期して実行されます。</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">BodyRosItem - Prototype definition of start()</span><a class="headerlink" href="#id12" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">start</span><span class="p">(</span><span class="n">Target</span><span class="o">*</span> <span class="n">target</span><span class="p">);</span>
</span>    <span class="k">virtual</span> <span class="kt">double</span> <span class="nf">timeStep</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">timeStep_</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">input</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">control</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">output</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<p>start() には、各トピックでパブリッシュするメッセージの初期化処理、トピックをパブリッシュする為のインスタンス (パブリッシャー) の生成処理、ROS ノードの生成および起動処理を実装します。</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::start()</span><a class="headerlink" href="#id13" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="n">Target</span><span class="o">*</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">putln</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;Target not found&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">putln</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;BodyItem not found&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">controllerTarget</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
  <span class="n">simulationBody</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">();</span>
  <span class="n">timeStep_</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">worldTimeStep</span><span class="p">();</span>
  <span class="n">controlTime_</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>

<span class="hll">  <span class="c1">// buffer of preserve currently state of joints.</span>
</span><span class="hll">  <span class="n">joint_state_</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controlTime_</span><span class="p">);</span>
</span><span class="hll">  <span class="n">joint_state_</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
</span><span class="hll">  <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
</span><span class="hll">  <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
</span><span class="hll">  <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
</span><span class="hll">
</span><span class="hll">  <span class="c1">// preserve initial state of joints.</span>
</span><span class="hll">  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="n">Link</span><span class="o">*</span> <span class="n">joint</span> <span class="o">=</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joint</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">joint_state_</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
</span><span class="hll">    <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">();</span>
</span><span class="hll">    <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">dq</span><span class="p">();</span>
</span><span class="hll">    <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">();</span>
</span><span class="hll">  <span class="p">}</span>
</span>
<span class="hll">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">simulationBody</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
</span><span class="hll">  <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">name</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>
</span><span class="hll">  <span class="n">rosnode_</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span><span class="hll">  <span class="n">createSensors</span><span class="p">(</span><span class="n">simulationBody</span><span class="p">);</span>
</span>
<span class="hll">  <span class="n">joint_state_publisher_</span>     <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">JointState</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;joint_states&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span>  <span class="n">joint_state_update_period_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">joint_state_update_rate_</span><span class="p">;</span>
  <span class="n">joint_state_last_update_</span>   <span class="o">=</span> <span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>
  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Joint state update rate %f&quot;</span><span class="p">,</span> <span class="n">joint_state_update_rate_</span><span class="p">);</span>

<span class="hll">  <span class="n">async_ros_spin_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span><span class="hll">  <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</span>  
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>以下、ソースコードのハイライト箇所について順に説明します。</p>
<p>80 行目から 92 行目までは、ロボットの関節に関する情報をパブリッシュするメッセージの初期化処理です。</p>
<p>現行の Choreonoid ではシミュレーション実行中にモデルの構造が動的に変更される事は無いため、ここで対象モデルの関節数に合わせてデータのサイズを変更し、関節名、関節角度、関節角速度、トルク値を初期値として設定します。</p>
<p>取得した情報のパブリッシュ処理については「Implement control()」で説明します。</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::start() - initialize joint_state</span><a class="headerlink" href="#id14" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>80
81
82
83
84
85
86
87
88
89
90
91
92</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="n">timeStep_</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">worldTimeStep</span><span class="p">();</span>
  <span class="n">controlTime_</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>

  <span class="c1">// buffer of preserve currently state of joints.</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controlTime_</span><span class="p">);</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>

  <span class="c1">// preserve initial state of joints.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Link</span><span class="o">*</span> <span class="n">joint</span> <span class="o">=</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joint</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>100 行目から 102 行目は ROS ノードの生成、105 行目は ROS トピックの登録処理です。
103 行目の createSensors については説明が長くなるため後述します。</p>
<p>ros::NodeHnadler の引数に name (モデルの名前) を渡しています。
これにより生成したノードの名前は、モデルの名前となります。
また、ROS の仕様において、名前空間の文字列で - が使用できないため、std::replace で - を _ に置換します。</p>
<p>ノードの名前は、名前空間の親の名前となります。
このノードに対して生成したトピックやサービスは、親の名前空間に属するものとなります。
ただし、トピックやサービスの名前を / で開始した場合は、この限りではありません。</p>
<p>105 行目の場合、トピックは /[model name]/joint_states で提供されます。</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::start() - Create a ROS node and publishers</span><a class="headerlink" href="#id15" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>100
101
102
103
104
105</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">simulationBody</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
</span><span class="hll">  <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">name</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>
</span><span class="hll">  <span class="n">rosnode_</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span>  <span class="n">createSensors</span><span class="p">(</span><span class="n">simulationBody</span><span class="p">);</span>

<span class="hll">  <span class="n">joint_state_publisher_</span>     <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">JointState</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;joint_states&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>110 行目および 111 行目は、ROS のイベントループ開始処理です。</p>
<p>使用するスレッドの数を明示的に指定する場合は、ros::AsyncSpinner の引数にスレッド数を指定します。</p>
<p>明示的にスレッドの数を指定する必要が無い場合は、0 を指定すると ROS API 側で CPU の数に応じたスレッドが自動的に設定されます。</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::start() - Start ROS spinner</span><a class="headerlink" href="#id16" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>110
111</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="n">async_ros_spin_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<p>以下、103 行目の createSensors() について説明します。</p>
<p>createSensors は、このコントローラアイテムの親アイテム (BodyItem) が装備するセンサデバイスを取得し、各デバイスに対応するトピックのパブリッシャーの生成処理を実行します。</p>
<p>基本的に、引数で渡した body の devices を呼び出しセンサデバイスを取得、対応するセンサデバイスが存在する場合、それらのパブリッシャーを生成するといった処理の流れとなります。</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::createSensor() - Create publishers for force sensor devices</span><a class="headerlink" href="#id17" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">createSensors</span><span class="p">(</span><span class="n">BodyPtr</span> <span class="n">body</span><span class="p">)</span>
<span class="p">{</span>
<span class="hll">  <span class="n">forceSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">ForceSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
</span>  <span class="n">gyroSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">RateGyroSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">accelSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">AccelerationSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">visionSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">Camera</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">rangeVisionSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">RangeCamera</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">rangeSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">RangeSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>

<span class="hll">  <span class="n">force_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">forceSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span class="hll">  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">forceSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">ForceSensor</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">forceSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
</span><span class="hll">      <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Wrench</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span><span class="hll">      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateForceSensor</span><span class="p">,</span>
</span><span class="hll">                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
</span>      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create force sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>ロボットの関節に関する情報をパブリッシュする場合とは異なり、センサデバイスについては、デバイスの更新に同期したイベントシグナルが発行されるため、パブリッシュ処理を当該イベントシグナルに接続しデータ更新のタイミングでパブリッシュを実行するようにします。</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::createSensor() - sigStateChanged</span><a class="headerlink" href="#id18" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>129
130</pre></div></td><td class="code"><div class="highlight"><pre><span></span>      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateForceSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
</pre></div>
</td></tr></table></div>
</div>
<p>connect の引数で渡している BodyRosItem::updateForceSensor が、パブリッシュ処理の本体です。</p>
<p>パブリッシュするメッセージ (ここでは geomerty_mesg::Wrench) にセンサのデータをコピーし、当該メッセージをパブリッシュする実装です。</p>
<p>この実装ではデータのコピーのみですが、データの変換処理やデータのチェック処理が必要な場合、ここへそれらの実装を追加します。</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::updateForceSensor()</span><a class="headerlink" href="#id19" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>206
207
208
209
210
211
212
213
214
215
216</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateForceSensor</span><span class="p">(</span><span class="n">ForceSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Wrench</span> <span class="n">force</span><span class="p">;</span>
  <span class="n">force</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">5</span><span class="p">];</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">force</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id3">
<h5>シミュレーション停止時の処理<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>シミュレーション停止時に実行する必要がある処理は ControllerItem の stop() 仮想関数を実装します。
stop() はシミュレーションの停止に同期して実行されます。</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">BodyRosItem - Prototype definition of stop()</span><a class="headerlink" href="#id20" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">start</span><span class="p">(</span><span class="n">Target</span><span class="o">*</span> <span class="n">target</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">double</span> <span class="nf">timeStep</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">timeStep_</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">input</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">control</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">output</span><span class="p">();</span>
<span class="hll">    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>stop() には、トピックの停止処理 (stop_publish)、ROS ノードの停止処理を実装します。</p>
<p>また、終了時に開放処理が必要なもの等についても、ここに実装します。</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::stop</span><a class="headerlink" href="#id21" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="hll">    <span class="n">stop_publish</span><span class="p">();</span>
</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">async_ros_spin_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rosnode_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::stop_publish</span><a class="headerlink" href="#id22" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">stop_publish</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">force_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rate_gyro_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rate_gyro_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">accel_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">accel_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vision_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range_vision_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range_vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="implement-control">
<h4>Implement control()<a class="headerlink" href="#implement-control" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>制御処理は、ControllerItem の control() 仮想関数を実装することで実現します。</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">BodyRosItem - Prototype definition of control()</span><a class="headerlink" href="#id23" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">input</span><span class="p">();</span>
<span class="hll">    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">control</span><span class="p">();</span>
</span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">output</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
</pre></div>
</td></tr></table></div>
</div>
<p>control() は、シミュレーションの実行周期で呼びされます。
シミュレーションの実行周期は、Choreonoid のタイムバーの設定で指定した周期となります。
以下の設定の場合、1ms 周期で control が呼び出されます。</p>
<img alt="_images/time-bar-config.png" src="_images/time-bar-config.png" />
<p>BodyRosItem では、control でロボットの関節に関する情報のパブリッシュ処理を実行しています。</p>
<p>currentTime で現在のシミュレーション時間を取得し、パブリッシュの出力周期毎 (デフォルト値 10ms) に、関節角度、関節角速度、トルク値をコピーしパブリッシュ処理を実行します。</p>
<img alt="_images/bodyros-publish-rate.png" src="_images/bodyros-publish-rate.png" />
<p>関節名 (joint-&gt;name()) については、先に説明した通りシミュレーション中に変更が発生しないため、コピー対象外としています。</p>
<p>なお、ここでは返り値を常に true としていますが、制御処理において動作に支障をきたすような状態となった場合は、false を返す事で、当該コントローラの動作を停止する事が可能です。</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">BodyRosItem::control()</span><a class="headerlink" href="#id24" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">control</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">controlTime_</span> <span class="o">=</span> <span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">updateSince</span> <span class="o">=</span> <span class="n">controlTime_</span> <span class="o">-</span> <span class="n">joint_state_last_update_</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">updateSince</span> <span class="o">&gt;</span> <span class="n">joint_state_update_period_</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// publish current joint states</span>
    <span class="n">joint_state_</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controlTime_</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Link</span><span class="o">*</span> <span class="n">joint</span> <span class="o">=</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joint</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

      <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">();</span>
      <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">dq</span><span class="p">();</span>
      <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">joint_state_publisher_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">joint_state_</span><span class="p">);</span>
    <span class="n">joint_state_last_update_</span> <span class="o">+=</span> <span class="n">joint_state_update_period_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="implement-a-other-than-controller">
<h3>Implement a other than controller<a class="headerlink" href="#implement-a-other-than-controller" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コントローラ以外の実装について、Choreonoid ROS プラグインの WorldRosItem の実装を元に説明を記載します。</p>
<p>WorldRosItem が提供する機能については、<a class="reference internal" href="manual.html#manual-ros-topics"><span class="std std-ref">ROSトピックス</span></a> の注釈を参照してください。</p>
<div class="section" id="decide-to-base-class">
<h4>Decide to base class<a class="headerlink" href="#decide-to-base-class" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Choreonoid フレームワーク上で共有されるオブジェクトを実装するためのクラスとして用意された Item クラスを基底クラスとします。</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">WorldRosItem - Class definition</span><a class="headerlink" href="#id25" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>72</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CNOID_EXPORT</span> <span class="nl">WorldRosItem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">Item</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="implement-processing-of-initialize">
<h4>Implement processing of initialize<a class="headerlink" href="#implement-processing-of-initialize" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="section" id="id4">
<h5>初回実行時のみの処理<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>初回実行時のみ必要な処理の実装は、Implement a controller の Implement initialize() と同様ですので、そちらを参照してください。</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">WorldRosItem::initialize()</span><a class="headerlink" href="#id26" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ros</span><span class="o">::</span><span class="n">isInitialized</span><span class="p">())</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;choreonoid&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">registerClass</span><span class="o">&lt;</span><span class="n">WorldRosItem</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;WorldRosItem&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">addCreationPanel</span><span class="o">&lt;</span><span class="n">WorldRosItem</span><span class="o">&gt;</span><span class="p">();</span>
</span>    <span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id5">
<h5>シミュレーション開始・終了時の処理<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>シミュレーション開始・終了時の処理について、Item クラスは ControllerItem クラスと違い、シミュレーション開始・終了時に呼び出される関数が存在しないため、同様の機能を実現するための実装が必要となります。</p>
<p>WorldRosItem の実装では、これを SimulatorItem クラスの機能である sigSimulationStarted イベントシグナル (シミュレーション開始時) および、sigSimulationFinished イベントシグナル (シミュレーション終了時) に、開始・終了処理をそれぞれ接続することで実現しています。</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">WorldRosItem - signal connections</span><a class="headerlink" href="#id27" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">registrationNodeStartAndStop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">WorldItemPtr</span> <span class="n">parent</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">SimulatorItemPtr</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findOwnerItem</span><span class="o">&lt;</span><span class="n">WorldItem</span><span class="o">&gt;</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">Item</span><span class="o">*</span> <span class="n">child</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">childItem</span><span class="p">();</span> <span class="n">child</span><span class="p">;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">nextItem</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SimulatorItemPtr</span> <span class="n">p</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">SimulatorItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">isRunning</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
<span class="hll">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">sigSimulationStarted</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
</span><span class="hll">        <span class="n">p</span><span class="o">-&gt;</span><span class="n">sigSimulationFinished</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
</span>
        <span class="n">registration_node_management_</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#if (DEBUG_WORLDROSITEM &gt; 0)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">registration_node_management_</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: regsitered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: already registered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="cp">#endif  </span><span class="cm">/* (DEBUG_WORLDROSITEM &gt; 0) */</span><span class="cp"></span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>接続している関数が ControllerItem 使用の場合と同名の start() および stop() となっていますが、こちらは WorldRosItem で宣言した関数である事に留意してください。</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">WorldRosItem - prototype definitions of start() and stop()</span><a class="headerlink" href="#id28" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CNOID_EXPORT</span> <span class="nl">WorldRosItem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">Item</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">);</span>
    
    <span class="n">WorldRosItem</span><span class="p">();</span>
    <span class="n">WorldRosItem</span><span class="p">(</span><span class="k">const</span> <span class="n">WorldRosItem</span><span class="o">&amp;</span> <span class="n">org</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">WorldRosItem</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">store</span><span class="p">(</span><span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">restore</span><span class="p">(</span><span class="k">const</span> <span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">);</span>

<span class="hll">    <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
</span><span class="hll">    <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
</span></pre></div>
</td></tr></table></div>
</div>
<p>開始処理である WorldRosItem::start() は、ControllerItem の場合と同様に ROS ノードの生成および、ROS トピックの登録処理を実装します。</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">WorldRosItem::start()</span><a class="headerlink" href="#id29" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">world</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findOwnerItem</span><span class="o">&lt;</span><span class="n">WorldItem</span><span class="o">&gt;</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">sim</span> <span class="o">=</span> <span class="n">SimulatorItem</span><span class="o">::</span><span class="n">findActiveSimulatorItemFor</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Found WorldItem: %s&quot;</span><span class="p">,</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Found SimulatorItem: %s&quot;</span><span class="p">,</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>

<span class="hll">  <span class="n">rosnode_</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="p">(</span><span class="n">cnoidrospkg_parent_namespace_</span><span class="p">));</span>
</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">publish_clk_update_rate_</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">publish_clk_update_rate_</span> <span class="o">&lt;=</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">    <span class="n">pub_clock_</span>                   <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">rosgraph_msgs</span><span class="o">::</span><span class="n">Clock</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;/clock&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span>    <span class="n">publish_clk_update_interval_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">publish_clk_update_rate_</span><span class="p">;</span>
    <span class="n">publish_clk_next_time_</span>       <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>終了処理である WorldRosItem::stop() も、ControllerItem の場合と同様に ROS トピックの停止処理および ROS ノードの停止処理を実装します。</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">WorldRosItem::stop()</span><a class="headerlink" href="#id30" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">sim</span><span class="o">-&gt;</span><span class="n">removePostDynamicsFunction</span><span class="p">(</span><span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rosqueue_</span><span class="p">.</span><span class="n">isEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">rosqueue_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">async_ros_spin_</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">      <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
</span>    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rosnode_</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">      <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
</span>    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="implement-processing-of-publish">
<h4>Implement processing of publish<a class="headerlink" href="#implement-processing-of-publish" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>パブリッシュ処理についても、Item クラスには、ControllerItem の control() に相当する関数が存在しないため、こちらもシミュレーション開始・終了処理と同様に、機能を実現するための実装が必要となります。</p>
<p>WorldRosItem の実装では、SimulatorItem クラスの機能である、シミュレーション処理と同期して任意の関数を実行する機能 (フック) へ、パブリッシュ処理の関数を登録する事で実現しています。</p>
<div class="literal-block-wrapper docutils container" id="id31">
<div class="code-block-caption"><span class="caption-text">WorldRosItem::start() - addPostDynamicsFunction</span><a class="headerlink" href="#id31" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">world</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findOwnerItem</span><span class="o">&lt;</span><span class="n">WorldItem</span><span class="o">&gt;</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">sim</span> <span class="o">=</span> <span class="n">SimulatorItem</span><span class="o">::</span><span class="n">findActiveSimulatorItemFor</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Found WorldItem: %s&quot;</span><span class="p">,</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Found SimulatorItem: %s&quot;</span><span class="p">,</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>

  <span class="n">rosnode_</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="p">(</span><span class="n">cnoidrospkg_parent_namespace_</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">publish_clk_update_rate_</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">publish_clk_update_rate_</span> <span class="o">&lt;=</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pub_clock_</span>                   <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">rosgraph_msgs</span><span class="o">::</span><span class="n">Clock</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;/clock&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">publish_clk_update_interval_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">publish_clk_update_rate_</span><span class="p">;</span>
    <span class="n">publish_clk_next_time_</span>       <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
<span class="hll">      <span class="n">sim</span><span class="o">-&gt;</span><span class="n">addPostDynamicsFunction</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishClock</span><span class="p">,</span> <span class="k">this</span><span class="p">)));</span>
</span>  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>ここでは addPostDynamicsFunction を使用していますが、シミュレーション処理内 (SimulatorItem::stepSimulation()) で実行されるタイミングに応じて 3 種類のフックが用意されていますので、用途に応じて使い分ける事が可能です。</p>
<p>用意されているフックとその実行タイミングは以下の通りです。</p>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="18%" />
<col width="19%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" rowspan="2">フック</th>
<th class="head" colspan="2">コントローラ実行</th>
<th class="head" rowspan="2">物理演算処理の実行</th>
</tr>
<tr class="row-even"><th class="head">Immeidate</th>
<th class="head">非 Immediate</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-odd"><td>addPreDynamicsFunction</td>
<td>Not yet</td>
<td>Not yet</td>
<td>Not yet</td>
</tr>
<tr class="row-even"><td>addMidDynamicsFunction</td>
<td>Done</td>
<td>Not yet</td>
<td>Not yet</td>
</tr>
<tr class="row-odd"><td>addPostDynamicsFunction</td>
<td>Done</td>
<td>Not yet</td>
<td>Done</td>
</tr>
</tbody>
</table>
<p>パブリッシュ処理の本体は WorldRosItem::publishClock() です。</p>
<p>ユーザ指定の周期毎にシミュレーション時間をパブリッシュする実装です。</p>
<div class="literal-block-wrapper docutils container" id="id32">
<div class="code-block-caption"><span class="caption-text">WorldRosItem::publishClock()</span><a class="headerlink" href="#id32" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>396
397
398
399
400
401
402
403
404
405
406
407
408
409</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishClock</span><span class="p">()</span>
<span class="p">{</span>
<span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">publish_clk_next_time_</span> <span class="o">&gt;</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">())</span> <span class="p">{</span>
</span>    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">rosgraph_msgs</span><span class="o">::</span><span class="n">Clock</span> <span class="n">ros_time_</span><span class="p">;</span>

<span class="hll">  <span class="n">ros_time_</span><span class="p">.</span><span class="n">clock</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
</span>  <span class="n">pub_clock_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">ros_time_</span><span class="p">);</span>
  <span class="n">publish_clk_next_time_</span> <span class="o">+=</span> <span class="n">publish_clk_update_interval_</span><span class="p">;</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>WorldRosItem は、シミレーション開始時にフックの登録を実行する実装となっているため、シミュレーション停止時にフックの解除を実装します。</p>
<p>フックの解除に用いる関数は、フックの add を remove に置き換えた関数を使用します。</p>
<div class="literal-block-wrapper docutils container" id="id33">
<div class="code-block-caption"><span class="caption-text">WorldRosItem::stop() - removePostDynamicsFunction()</span><a class="headerlink" href="#id33" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>600
601
602
603
604
605</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="hll">    <span class="n">sim</span><span class="o">-&gt;</span><span class="n">removePostDynamicsFunction</span><span class="p">(</span><span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
</span>    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="common-matters">
<h3>Common matters<a class="headerlink" href="#common-matters" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ここでは実装した機能をプラグインとして動作させる手順を説明します。</p>
<div class="section" id="if-you-adds-new-feature-in-this-plugin">
<h4>If you adds new feature in this plugin<a class="headerlink" href="#if-you-adds-new-feature-in-this-plugin" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Choreonoid ROS プラグイン本体へ機能を追加するにあたり、ソースファイルを新規に作成した場合、当該ソースファイルを choreonoid_ros_pkg/choreonoid_plugins/CMakeLists.txt の add_cnoid_plugin に追加しビルド対象とする必要があります。</p>
<div class="literal-block-wrapper docutils container" id="id34">
<div class="code-block-caption"><span class="caption-text">choreonoid_plugins/CMakeLists.txt</span><a class="headerlink" href="#id34" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cmake"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>195
196
197
198
199
200
201
202
203
204</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">## Plugins</span>
<span class="nb">add_cnoid_plugin</span><span class="p">(</span><span class="s">CnoidRosBodyPlugin</span>
  <span class="s">SHARED</span>
  <span class="s">src/RosBodyPlugin.cpp</span>
  <span class="s">src/BodyRosItem.cpp</span>
  <span class="s">src/WorldRosItem.cpp</span>
  <span class="s">src/BodyRosJointControllerItem.cpp</span>
  <span class="s">src/BodyRosTorqueControllerItem.cpp</span>
  <span class="s">src/BodyRosHighgainControllerItem.cpp</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>また、Choreonoid ROS プラグイン本体へ機能を追加した場合、RosBodyPlugin::initialize() へ実装したクラスの initialize() 呼び出しを追加する必要があります。</p>
<div class="literal-block-wrapper docutils container" id="id35">
<div class="code-block-caption"><span class="caption-text">RosBodyPlugin::initialize()</span><a class="headerlink" href="#id35" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">BodyRosTorqueControllerItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">BodyRosHighgainControllerItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>これらの対応がなされていない場合、追加した機能は有効になりません。</p>
</div>
<div class="section" id="definition-of-plugin-entry">
<h4>Definition of plugin entry<a class="headerlink" href="#definition-of-plugin-entry" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>プラグインエントリの定義は RosBodyPlugin.cpp にあります。
この定義は変更しないでください。</p>
<div class="literal-block-wrapper docutils container" id="id36">
<div class="code-block-caption"><span class="caption-text">RosBodyPlugin - Plugin entry</span><a class="headerlink" href="#id36" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">CNOID_IMPLEMENT_PLUGIN_ENTRY</span><span class="p">(</span><span class="n">RosBodyPlugin</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
<div class="section" id="others">
<h3>Others<a class="headerlink" href="#others" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="copy-a-header-file-not-installed">
<h4>Copy a header file not installed<a class="headerlink" href="#copy-a-header-file-not-installed" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Choreonoid のヘッダファイルの中には、インストール対象外となっているものが存在します。</p>
<p>プラグインの実装において、これらのヘッダファイルを必要とする状況となった場合、choreonoid_ros/CMakeLists.txt で install を使用し対応する事が可能です。</p>
<div class="literal-block-wrapper docutils container" id="id37">
<div class="code-block-caption"><span class="caption-text">choreonoid_ros/CMakeLists.txt - Parts</span><a class="headerlink" href="#id37" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cmake"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">execute_process</span><span class="p">(</span>
  <span class="s">COMMAND</span> <span class="s">find</span> <span class="o">${</span><span class="nv">CATKIN_DEVEL_PREFIX</span><span class="o">}</span><span class="s">/include</span> <span class="s">-name</span> <span class="s2">&quot;choreonoid-*&quot;</span>
  <span class="s">OUTPUT_VARIABLE</span> <span class="s">_cnoid_include_path</span>
  <span class="s">OUTPUT_STRIP_TRAILING_WHITESPACE</span>
<span class="p">)</span>

<span class="c">#</span>
<span class="c"># Although it is not installed by the standard installation process of Chorenoid,</span>
<span class="c"># it is a header file necessary for the build of the Choreonoid ROS plugin,</span>
<span class="c"># so the following correspondence is made.</span>
<span class="c">#</span>
<span class="nb">execute_process</span><span class="p">(</span>
  <span class="s">COMMAND</span> <span class="s">find</span> <span class="o">${</span><span class="nv">CATKIN_DEVEL_PREFIX</span><span class="o">}</span><span class="s">/../build</span> <span class="s">-name</span> <span class="s2">&quot;choreonoid-master&quot;</span>
  <span class="s">OUTPUT_VARIABLE</span> <span class="s">_cnoid_build_path</span>
  <span class="s">OUTPUT_STRIP_TRAILING_WHITESPACE</span>
<span class="p">)</span>

<span class="nb">if</span><span class="p">(</span><span class="s2">&quot;${_cnoid_include_path}&quot;</span> <span class="s">STREQUAL</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="nb">message</span><span class="p">(</span><span class="s">WARNING</span> <span class="s2">&quot;Chorenoid include directory not found&quot;</span><span class="p">)</span>
<span class="nb">elseif</span><span class="p">(</span><span class="s2">&quot;${_cnoid_build_path}&quot;</span> <span class="s">STREQUAL</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="nb">message</span><span class="p">(</span><span class="s">WARNING</span> <span class="s2">&quot;Chorenoid build directory not found&quot;</span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
<span class="hll">  <span class="nb">install</span><span class="p">(</span>
</span><span class="hll">    <span class="s">FILES</span> <span class="o">${</span><span class="nv">_cnoid_build_path</span><span class="o">}</span><span class="s">/src/BodyPlugin/AISTSimulatorItem.h</span>
</span><span class="hll">    <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">_cnoid_include_path</span><span class="o">}</span><span class="s">/cnoid/src/BodyPlugin</span>
</span><span class="hll">  <span class="p">)</span>
</span><span class="nb">endif</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<p>本項は、所謂バッドノウハウと呼ばれるものであり、Choreonoid ROS プラグインの Choreonoid に限定した内容である事に留意してください。</p>
</div>
<div class="section" id="input-and-output-in-controlleritem-class">
<h4>Input() and output() in ControllerItem class<a class="headerlink" href="#input-and-output-in-controlleritem-class" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Choreonoid ROS プラグインでは使用していませんが、制御処理において、入力処理、制御処理、出力処理の流れで処理を実装する場合は、ControllerItem の input() および output() 仮想関数を実装する事で実現可能です。</p>
<p>簡単な処理である場合を除き、input()、control()、output() それぞれの実装で制御処理を実現する事を推奨します。</p>
</div>
</div>
</div>
<div class="section" id="porting-gazebo-ros-plguin">
<h2>Porting Gazebo ROS plguin<a class="headerlink" href="#porting-gazebo-ros-plguin" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>この節では、Gazebo ROS プラグインからの移植について記載します。</p>
<p>本節の内容は、前節の説明を理解している事が前提となります。</p>
<div class="section" id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="porting-initialization-functions-of-gazebo-plugin">
<h4>Porting initialization functions of Gazebo plugin<a class="headerlink" href="#porting-initialization-functions-of-gazebo-plugin" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Gazebo ROS プラグインの実装において、初期化に関する処理は基本的に Load()、Init()、Reset() をオーバーライドした関数、コンストラクタで実行する実装となっています。</p>
<p>よって、移植の際は、これらの実装を前節で述べた initialize()、start()、コンストラクタへ適切に実装する事で、同等の機能を実現できます。</p>
</div>
<div class="section" id="initial-potures-of-models">
<h4>Initial potures of models<a class="headerlink" href="#initial-potures-of-models" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Gazebo ROS プラグインの実装において、モデルの初期姿勢を設定する処理については、start() への実装による設定ではなく Choreonoid のユーザ・インタフェース「関節スライダ」で初期姿勢を設定したプロジェクトを使用する事を推奨します。</p>
<img alt="_images/joint-sliders.png" src="_images/joint-sliders.png" />
</div>
<div class="section" id="properties-in-the-urdf-or-xacro-files">
<h4>Properties in the urdf or xacro files<a class="headerlink" href="#properties-in-the-urdf-or-xacro-files" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>現行の Choreonoid ROS プラグインでは、urdf ファイルや xacro ファイル内のプロパティによる設定をサポートしていません。</p>
<p>よって、Gazebo ROS プラグインの初期化に関する処理において、当該プロパティを使用している場合、以下のいずれかの実装で置き換える必要があります。</p>
<ul class="simple">
<li>Choreonoid のプロパティとして実装する</li>
<li><a class="reference external" href="http://choreonoid.org/ja/manuals/latest/handling-models/modelfile/modelfile-yaml.html">YAML による追加情報ファイル</a> を用意し start でこの情報を使用する</li>
</ul>
</div>
</div>
<div class="section" id="finalization">
<h3>Finalization<a class="headerlink" href="#finalization" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Gazebo ROS プラグインの実装において、デストラクタで実装している停止処理については、Choreonoid ROS プラグインでは、前節で説明した stop() へ実装するようにしてください。</p>
<p>Choreonoid ROS プラグインのデストラクタへは、Choreonoid 終了時に実行する処理のみを実装するようにしてください。</p>
</div>
<div class="section" id="id6">
<h3>Implement control()<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Gazebo ROS プラグインの実装において、コントローラは基本的に <a class="reference external" href="http://osrf-distributions.s3.amazonaws.com/gazebo/api/dev/group__gazebo__event.html">Gazebo のイベント</a> (例えば Events::ConnectWorldUpdateBigin 等) に、コントローラの処理を実装した関数を割り当てる実装となっています。</p>
<p>具体例としては、 <a class="reference external" href="https://github.com/ros-simulation/gazebo_ros_pkgs/blob/kinetic-devel/gazebo_plugins/src/gazebo_ros_template.cpp">GazeboRosTemplate クラス</a> の場合、UpdateChild() がコントローラの処理を実装した関数となります。</p>
<p>移植の際は、この実装を前節で述べた control() に実装する事で同等の機能を実現できます。</p>
</div>
<div class="section" id="porting-functions">
<h3>Porting functions<a class="headerlink" href="#porting-functions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>関数の移植については、 <a class="reference external" href="http://choreonoid.org/ja/manuals/latest/install/build-ubuntu.html#id5">Choreonoid が必要とするライブラリ</a> と競合するライブラリを使用している場合、これを回避するための修正もしくは改修が必須となります。
また、状況によっては移植不可能となる場合もあるため、移植に際し事前に確認する事を推奨します。</p>
<p>また、 <a class="reference external" href="http://osrf-distributions.s3.amazonaws.com/gazebo/api/dev/classgazebo_1_1math_1_1Quaternion.html">Gazebo の Quarternion</a> や <a class="reference external" href="http://docs.ros.org/api/tf/html/c++/classtf_1_1Vector3.html">ROS の Vector3</a> を使用している場合、cnoid::Quaternion や cnoid::Vector3 と区別するため名前空間を正確に指定する必要があります。</p>
</div>
<div class="section" id="logging-and-notifications-to-users">
<h3>Logging and notifications to users<a class="headerlink" href="#logging-and-notifications-to-users" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ROS のストリーム出力 (ROS_INFO 等) は、そのままの使用で問題ありません。
Choreonoid ROS プラグインでも随所で使用しています。</p>
<p>Gazebo のストリーム出力 (gzmsg 等) については、特に理由が無ければ ROS のストリーム出力もしくは、C++ のストリーム出力への使用変更を推奨します。</p>
<p>Choreonoid を使用しているユーザに対するメッセージを出力する場合は、MessageView クラスを使用します。</p>
<p>以下のコードは、Choreonoid のメッセージビューに「An error ocurred in controller」を出力する例となります。</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">putln</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;An error ocurred in controller&quot;</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>本章の説明で使用したソースコードを添付します。</p>
<div class="section" id="bodyrositem-h">
<h3>BodyRosItem.h<a class="headerlink" href="#bodyrositem-h" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id38">
<div class="code-block-caption"><span class="caption-text">BodyRosItem.h</span><a class="headerlink" href="#id38" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#ifndef CNOID_ROS_PLUGIN_BODY_ROS_ITEM_H_INCLUDED</span>
<span class="cp">#define CNOID_ROS_PLUGIN_BODY_ROS_ITEM_H_INCLUDED</span>

<span class="cp">#include</span> <span class="cpf">&lt;cnoid/ControllerItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/BasicSensorSimulationHelper&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Body&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Device&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/DeviceList&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Camera&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/RangeCamera&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/RangeSensor&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Archive&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;exportdecl.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/JointState.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/Imu.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/Image.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/image_encodings.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/PointCloud2.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/LaserScan.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/Wrench.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;image_transport/image_transport.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">cnoid</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">CNOID_EXPORT</span> <span class="nl">BodyRosItem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">ControllerItem</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">);</span>
    
    <span class="n">BodyRosItem</span><span class="p">();</span>
    <span class="n">BodyRosItem</span><span class="p">(</span><span class="k">const</span> <span class="n">BodyRosItem</span><span class="o">&amp;</span> <span class="n">org</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">BodyRosItem</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="nf">createSensors</span><span class="p">(</span><span class="n">BodyPtr</span> <span class="n">body</span><span class="p">);</span>
    
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">start</span><span class="p">(</span><span class="n">Target</span><span class="o">*</span> <span class="n">target</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">double</span> <span class="nf">timeStep</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">timeStep_</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">input</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">control</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">output</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
    
    <span class="k">const</span> <span class="n">BodyPtr</span><span class="o">&amp;</span> <span class="n">body</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">simulationBody</span><span class="p">;</span> <span class="p">};</span>
    <span class="k">const</span> <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">ForceSensor</span><span class="o">&gt;&amp;</span> <span class="n">forceSensors</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">forceSensors_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">RateGyroSensor</span><span class="o">&gt;&amp;</span> <span class="n">gyroSensors</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">gyroSensors_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">AccelerationSensor</span><span class="o">&gt;&amp;</span> <span class="n">accelSensors</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">accelSensors_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">Camera</span><span class="o">&gt;&amp;</span> <span class="n">visionSensors</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">visionSensors_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">RangeCamera</span><span class="o">&gt;&amp;</span> <span class="n">rangeVisionSensors</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">rangeVisionSensors_</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">RangeSensor</span><span class="o">&gt;&amp;</span> <span class="n">rangeSensors</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">rangeSensors_</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="kt">double</span> <span class="n">controlTime</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">controlTime_</span><span class="p">;</span> <span class="p">}</span>
    
    <span class="kt">void</span> <span class="n">setModuleName</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="n">Item</span><span class="o">*</span> <span class="n">doDuplicate</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">store</span><span class="p">(</span><span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">restore</span><span class="p">(</span><span class="k">const</span> <span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">doPutProperties</span><span class="p">(</span><span class="n">PutPropertyFunction</span><span class="o">&amp;</span> <span class="n">putProperty</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">BodyPtr</span> <span class="n">simulationBody</span><span class="p">;</span>
    <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">ForceSensor</span><span class="o">&gt;</span> <span class="n">forceSensors_</span><span class="p">;</span>
    <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">RateGyroSensor</span><span class="o">&gt;</span> <span class="n">gyroSensors_</span><span class="p">;</span>
    <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">AccelerationSensor</span><span class="o">&gt;</span> <span class="n">accelSensors_</span><span class="p">;</span>
    <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">Camera</span><span class="o">&gt;</span> <span class="n">visionSensors_</span><span class="p">;</span>
    <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">RangeCamera</span><span class="o">&gt;</span> <span class="n">rangeVisionSensors_</span><span class="p">;</span>
    <span class="n">DeviceList</span><span class="o">&lt;</span><span class="n">RangeSensor</span><span class="o">&gt;</span> <span class="n">rangeSensors_</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">timeStep_</span><span class="p">;</span>

    <span class="cm">/* joint states */</span>
    <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">JointState</span> <span class="n">joint_state_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">joint_state_publisher_</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">joint_state_update_rate_</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">joint_state_update_period_</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">joint_state_last_update_</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">Target</span><span class="o">*</span> <span class="n">controllerTarget</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">controlTime_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">bodyName</span><span class="p">;</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span> <span class="n">rosnode_</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="o">&gt;</span> <span class="n">async_ros_spin_</span><span class="p">;</span>
 
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&gt;</span> <span class="n">force_sensor_publishers_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&gt;</span> <span class="n">rate_gyro_sensor_publishers_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&gt;</span> <span class="n">accel_sensor_publishers_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_transport</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&gt;</span> <span class="n">vision_sensor_publishers_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&gt;</span> <span class="n">range_vision_sensor_publishers_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&gt;</span> <span class="n">range_sensor_publishers_</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">updateForceSensor</span><span class="p">(</span><span class="n">ForceSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">updateRateGyroSensor</span><span class="p">(</span><span class="n">RateGyroSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">updateAccelSensor</span><span class="p">(</span><span class="n">AccelerationSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">updateVisionSensor</span><span class="p">(</span><span class="n">Camera</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">image_transport</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">updateRangeVisionSensor</span><span class="p">(</span><span class="n">RangeCamera</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">updateRangeSensor</span><span class="p">(</span><span class="n">RangeSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">);</span>

    <span class="cm">/**</span>
<span class="cm">      @brief Stop publish.</span>
<span class="cm">      This method call from BodyRosItem::stop.</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">stop_publish</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span> <span class="n">BodyRosItemPtr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="bodyrositem-cpp">
<h3>BodyRosItem.cpp<a class="headerlink" href="#bodyrositem-cpp" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id39">
<div class="code-block-caption"><span class="caption-text">choreonoid_ros_pkg/choreonoid_plugins/src/BodyRosItem.cpp</span><a class="headerlink" href="#id39" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;BodyRosItem.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/BodyItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Link&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Sensor&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/ItemManager&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/MessageView&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ros/console.h&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">cnoid</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ros</span><span class="o">::</span><span class="n">isInitialized</span><span class="p">())</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;choreonoid&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">registerClass</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;BodyRosItem&quot;</span><span class="p">);</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">addCreationPanel</span><span class="o">&lt;</span><span class="n">BodyRosItem</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">BodyRosItem</span><span class="o">::</span><span class="n">BodyRosItem</span><span class="p">()</span>
  <span class="o">:</span> <span class="n">os</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cout</span><span class="p">())</span>
<span class="p">{</span>
  <span class="n">controllerTarget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">joint_state_update_rate_</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BodyRosItem</span><span class="o">::</span><span class="n">BodyRosItem</span><span class="p">(</span><span class="k">const</span> <span class="n">BodyRosItem</span><span class="o">&amp;</span> <span class="n">org</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">ControllerItem</span><span class="p">(</span><span class="n">org</span><span class="p">),</span>
    <span class="n">os</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cout</span><span class="p">())</span>
<span class="p">{</span>
  <span class="n">controllerTarget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">joint_state_update_rate_</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BodyRosItem</span><span class="o">::~</span><span class="n">BodyRosItem</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">stop</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Item</span><span class="o">*</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">doDuplicate</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">BodyRosItem</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">store</span><span class="p">(</span><span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;jointStateUpdateRate&quot;</span><span class="p">,</span> <span class="n">joint_state_update_rate_</span><span class="p">);</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">restore</span><span class="p">(</span><span class="k">const</span> <span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;jointStateUpdateRate&quot;</span><span class="p">,</span> <span class="n">joint_state_update_rate_</span><span class="p">);</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">doPutProperties</span><span class="p">(</span><span class="n">PutPropertyFunction</span><span class="o">&amp;</span> <span class="n">putProperty</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">putProperty</span><span class="p">.</span><span class="n">decimals</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)(</span><span class="s">&quot;Update rate&quot;</span><span class="p">,</span> <span class="n">joint_state_update_rate_</span><span class="p">,</span> <span class="n">changeProperty</span><span class="p">(</span><span class="n">joint_state_update_rate_</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="n">Target</span><span class="o">*</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">putln</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;Target not found&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">MessageView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">putln</span><span class="p">(</span><span class="n">MessageView</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;BodyItem not found&quot;</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">controllerTarget</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
  <span class="n">simulationBody</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">();</span>
  <span class="n">timeStep_</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">worldTimeStep</span><span class="p">();</span>
  <span class="n">controlTime_</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>

  <span class="c1">// buffer of preserve currently state of joints.</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controlTime_</span><span class="p">);</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>
  <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">());</span>

  <span class="c1">// preserve initial state of joints.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Link</span><span class="o">*</span> <span class="n">joint</span> <span class="o">=</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joint</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="n">joint_state_</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
    <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">();</span>
    <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">dq</span><span class="p">();</span>
    <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">simulationBody</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">name</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>
  <span class="n">rosnode_</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
  <span class="n">createSensors</span><span class="p">(</span><span class="n">simulationBody</span><span class="p">);</span>

  <span class="n">joint_state_publisher_</span>     <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">JointState</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;joint_states&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="n">joint_state_update_period_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">joint_state_update_rate_</span><span class="p">;</span>
  <span class="n">joint_state_last_update_</span>   <span class="o">=</span> <span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>
  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Joint state update rate %f&quot;</span><span class="p">,</span> <span class="n">joint_state_update_rate_</span><span class="p">);</span>

  <span class="n">async_ros_spin_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
  
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">createSensors</span><span class="p">(</span><span class="n">BodyPtr</span> <span class="n">body</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">forceSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">ForceSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">gyroSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">RateGyroSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">accelSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">AccelerationSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">visionSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">Camera</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">rangeVisionSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">RangeCamera</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>
  <span class="n">rangeSensors_</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">devices</span><span class="o">&lt;</span><span class="n">RangeSensor</span><span class="o">&gt;</span><span class="p">().</span><span class="n">getSortedById</span><span class="p">();</span>

  <span class="n">force_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">forceSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">forceSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ForceSensor</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">forceSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Wrench</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateForceSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create force sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">rate_gyro_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">gyroSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">gyroSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RateGyroSensor</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">gyroSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">rate_gyro_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Imu</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateRateGyroSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">rate_gyro_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create gyro sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">accel_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">accelSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">accelSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">AccelerationSensor</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">accelSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">accel_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Imu</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateAccelSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">accel_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create accel sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">image_transport</span><span class="o">::</span><span class="n">ImageTransport</span> <span class="n">it</span><span class="p">(</span><span class="o">*</span><span class="n">rosnode_</span><span class="p">);</span>
  <span class="n">vision_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">visionSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">visionSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Camera</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">visionSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="n">advertise</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/image_raw&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateVisionSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create vision sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">range_vision_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">rangeVisionSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rangeVisionSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RangeCamera</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">rangeVisionSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">range_vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">PointCloud2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/point_cloud&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateRangeVisionSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">range_vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create RGBD sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">range_sensor_publishers_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">rangeSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rangeSensors_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RangeSensor</span><span class="o">*</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">rangeSensors_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="n">range_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">LaserScan</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">sigStateChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateRangeSensor</span><span class="p">,</span>
                                                    <span class="k">this</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">range_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
      <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Create range sensor %s with cycle %f&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">control</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">controlTime_</span> <span class="o">=</span> <span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">updateSince</span> <span class="o">=</span> <span class="n">controlTime_</span> <span class="o">-</span> <span class="n">joint_state_last_update_</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">updateSince</span> <span class="o">&gt;</span> <span class="n">joint_state_update_period_</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// publish current joint states</span>
    <span class="n">joint_state_</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controlTime_</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numJoints</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Link</span><span class="o">*</span> <span class="n">joint</span> <span class="o">=</span> <span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joint</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

      <span class="n">joint_state_</span><span class="p">.</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">();</span>
      <span class="n">joint_state_</span><span class="p">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">dq</span><span class="p">();</span>
      <span class="n">joint_state_</span><span class="p">.</span><span class="n">effort</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">joint</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">joint_state_publisher_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">joint_state_</span><span class="p">);</span>
    <span class="n">joint_state_last_update_</span> <span class="o">+=</span> <span class="n">joint_state_update_period_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateForceSensor</span><span class="p">(</span><span class="n">ForceSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Wrench</span> <span class="n">force</span><span class="p">;</span>
  <span class="n">force</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">force</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">F</span><span class="p">()[</span><span class="mi">5</span><span class="p">];</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">force</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateRateGyroSensor</span><span class="p">(</span><span class="n">RateGyroSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Imu</span> <span class="n">gyro</span><span class="p">;</span>
  <span class="n">gyro</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
  <span class="n">gyro</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
  <span class="n">gyro</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">gyro</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">gyro</span><span class="p">.</span><span class="n">angular_velocity</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">()[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">gyro</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateAccelSensor</span><span class="p">(</span><span class="n">AccelerationSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Imu</span> <span class="n">accel</span><span class="p">;</span>
  <span class="n">accel</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
  <span class="n">accel</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
  <span class="n">accel</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">accel</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">accel</span><span class="p">.</span><span class="n">linear_acceleration</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dv</span><span class="p">()[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">accel</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateVisionSensor</span><span class="p">(</span><span class="n">Camera</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">image_transport</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span> <span class="n">vision</span><span class="p">;</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">height</span><span class="p">();</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">width</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">numComponents</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">vision</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">image_encodings</span><span class="o">::</span><span class="n">RGB8</span><span class="p">;</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">numComponents</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vision</span><span class="p">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">image_encodings</span><span class="o">::</span><span class="n">MONO8</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">ROS_WARN</span><span class="p">(</span><span class="s">&quot;unsupported image component number: %i&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">numComponents</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">is_bigendian</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">width</span><span class="p">()</span> <span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">numComponents</span><span class="p">();</span>
  <span class="n">vision</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">vision</span><span class="p">.</span><span class="n">step</span> <span class="o">*</span> <span class="n">vision</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vision</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">().</span><span class="n">pixels</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">vision</span><span class="p">.</span><span class="n">step</span> <span class="o">*</span> <span class="n">vision</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">vision</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateRangeVisionSensor</span><span class="p">(</span><span class="n">RangeCamera</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">PointCloud2</span> <span class="n">range</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
  <span class="n">range</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
  <span class="n">range</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">resolutionX</span><span class="p">();</span>
  <span class="n">range</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">resolutionY</span><span class="p">();</span>
  <span class="n">range</span><span class="p">.</span><span class="n">is_bigendian</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">is_dense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">row_step</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">point_step</span> <span class="o">*</span> <span class="n">range</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">imageType</span><span class="p">()</span> <span class="o">==</span> <span class="n">cnoid</span><span class="o">::</span><span class="n">Camera</span><span class="o">::</span><span class="n">COLOR_IMAGE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
    <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rgb&quot;</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">PointField</span><span class="o">::</span><span class="n">FLOAT32</span><span class="p">;</span>
    <span class="cm">/*</span>
<span class="cm">    range.fields[3].name = &quot;r&quot;;</span>
<span class="cm">    range.fields[3].offset = 12;</span>
<span class="cm">    range.fields[3].datatype = sensor_msgs::PointField::UINT8;</span>
<span class="cm">    range.fields[3].count = 1;</span>
<span class="cm">    range.fields[4].name = &quot;g&quot;;</span>
<span class="cm">    range.fields[4].offset = 13;</span>
<span class="cm">    range.fields[4].datatype = sensor_msgs::PointField::UINT8;</span>
<span class="cm">    range.fields[4].count = 1;</span>
<span class="cm">    range.fields[5].name = &quot;b&quot;;</span>
<span class="cm">    range.fields[5].offset = 14;</span>
<span class="cm">    range.fields[5].datatype = sensor_msgs::PointField::UINT8;</span>
<span class="cm">    range.fields[5].count = 1;</span>
<span class="cm">    */</span>
    <span class="n">range</span><span class="p">.</span><span class="n">point_step</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">range</span><span class="p">.</span><span class="n">point_step</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;x&quot;</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">PointField</span><span class="o">::</span><span class="n">FLOAT32</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;y&quot;</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">PointField</span><span class="o">::</span><span class="n">FLOAT32</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;z&quot;</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">PointField</span><span class="o">::</span><span class="n">FLOAT32</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">fields</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Vector3f</span><span class="o">&gt;&amp;</span> <span class="n">points</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">constPoints</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pixels</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">constImage</span><span class="p">().</span><span class="n">pixels</span><span class="p">();</span>
  <span class="n">range</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">points</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="n">range</span><span class="p">.</span><span class="n">point_step</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">range</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">points</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">x</span><span class="p">();</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">y</span><span class="p">();</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="o">-</span> <span class="n">points</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">z</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">imageType</span><span class="p">()</span> <span class="o">==</span> <span class="n">cnoid</span><span class="o">::</span><span class="n">Camera</span><span class="o">::</span><span class="n">COLOR_IMAGE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dst</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pixels</span><span class="o">++</span><span class="p">;</span>
      <span class="n">dst</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pixels</span><span class="o">++</span><span class="p">;</span>
      <span class="n">dst</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pixels</span><span class="o">++</span><span class="p">;</span>
      <span class="n">dst</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dst</span> <span class="o">+=</span> <span class="n">range</span><span class="p">.</span><span class="n">point_step</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">updateRangeSensor</span><span class="p">(</span><span class="n">RangeSensor</span><span class="o">*</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&amp;</span> <span class="n">publisher</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sensor_msgs</span><span class="o">::</span><span class="n">LaserScan</span> <span class="n">range</span><span class="p">;</span>
  <span class="n">range</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">controllerTarget</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
  <span class="n">range</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
  <span class="n">range</span><span class="p">.</span><span class="n">range_max</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">maxDistance</span><span class="p">();</span>
  <span class="n">range</span><span class="p">.</span><span class="n">range_min</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minDistance</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">yawRange</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range</span><span class="p">.</span><span class="n">angle_max</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pitchRange</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">angle_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pitchRange</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">angle_increment</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pitchRange</span><span class="p">()</span> <span class="o">/</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pitchResolution</span><span class="p">());</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">range</span><span class="p">.</span><span class="n">angle_max</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">yawRange</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">angle_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">yawRange</span><span class="p">()</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
    <span class="n">range</span><span class="p">.</span><span class="n">angle_increment</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">yawRange</span><span class="p">()</span> <span class="o">/</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">yawResolution</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">range</span><span class="p">.</span><span class="n">ranges</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">rangeData</span><span class="p">().</span><span class="n">size</span><span class="p">());</span>
  <span class="c1">//range.intensities.resize(sensor-&gt;rangeData().size());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">rangeData</span><span class="p">().</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range</span><span class="p">.</span><span class="n">ranges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">rangeData</span><span class="p">()[</span><span class="n">j</span><span class="p">];</span>
    <span class="c1">//range.intensities[j] = -900000;</span>
  <span class="p">}</span>
  <span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">range</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">input</span><span class="p">()</span>
<span class="p">{</span>
  
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">output</span><span class="p">()</span>
<span class="p">{</span>
  
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">stop_publish</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">force_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">force_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rate_gyro_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rate_gyro_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">accel_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">accel_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vision_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range_vision_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range_vision_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">range_sensor_publishers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">range_sensor_publishers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shutdown</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">stop_publish</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">async_ros_spin_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rosnode_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="worldrositem-h">
<h3>WorldRosItem.h<a class="headerlink" href="#worldrositem-h" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id40">
<div class="code-block-caption"><span class="caption-text">choreonoid_ros_pkg/choreonoid_plugins/src/WorldRosItem.h</span><a class="headerlink" href="#id40" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">   @file WorldRosItem.h</span>
<span class="cm">   @author</span>
<span class="cm"> */</span>

<span class="cp">#ifndef CNOID_ROS_PLUGIN_WORLD_ROS_ITEM_H_INCLUDED</span>
<span class="cp">#define CNOID_ROS_PLUGIN_WORLD_ROS_ITEM_H_INCLUDED</span>

<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Item&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Body&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/DyBody&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/WorldItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/SimulatorItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/AISTSimulatorItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/TimeBar&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;exportdecl.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ros/callback_queue.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ros/subscribe_options.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;geometry_msgs/Wrench.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;std_srvs/Empty.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;rosgraph_msgs/Clock.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;gazebo_msgs/LinkStates.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;gazebo_msgs/ModelStates.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;gazebo_msgs/SpawnModel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;gazebo_msgs/DeleteModel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;gazebo_msgs/ContactsState.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;boost/thread.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">cnoid</span> <span class="p">{</span>

<span class="cm">/**</span>
<span class="cm">   @brief This class is for accessing protected &#39;getCollisions&#39; method in the SimulatorItem class.</span>
<span class="cm">   The use of this class is limited to this only. How to use, please see following example.</span>

<span class="cm">   @code</span>
<span class="cm">   SimulatorItemPtr               p;</span>
<span class="cm">   WorldRosSimulatorItemAccessor* sim_access;</span>

<span class="cm">   p          = &lt;set SimulatorItem&#39;s instance&gt;;</span>
<span class="cm">   sim_access = static_cast&lt;WorldRosSimulatorItemAccessor*&gt;(p.get());</span>

<span class="cm">   CollisionsLinkPairListPtr link_pairs = sim_access-&gt;get_collisions();</span>

<span class="cm">   if (link_pairs) {</span>
<span class="cm">     // This physics engine are collision output supported.</span>
<span class="cm">   } else {</span>
<span class="cm">     // This physics engine are not collision output supported.</span>
<span class="cm">   }</span>
<span class="cm">   @endcode</span>

<span class="cm">   @attention This class does not consider usage other than the contents described in the explanation.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">CNOID_EXPORT</span> <span class="nl">WorldRosSimulatorItemAccessor</span> <span class="p">:</span> <span class="k">public</span> <span class="n">SimulatorItem</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">WorldRosSimulatorItemAccessor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">CollisionLinkPairListPtr</span> <span class="n">get_collisions</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">getCollisions</span><span class="p">();</span> <span class="p">}</span>
  <span class="k">virtual</span> <span class="n">SimulationBody</span><span class="o">*</span> <span class="n">createSimulationBody</span><span class="p">(</span><span class="n">Body</span><span class="o">*</span> <span class="n">orgBody</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">initializeSimulation</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SimulationBody</span><span class="o">*&gt;&amp;</span> <span class="n">simBodies</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">stepSimulation</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SimulationBody</span><span class="o">*&gt;&amp;</span> <span class="n">activeSimBodies</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">WorldRosSimulatorItemAccessor</span><span class="o">&gt;</span> <span class="n">WorldRosSimulatorItemAccessorPtr</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm">   @brief This class is provides all services and some topics (link state, model state, contact state).</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">CNOID_EXPORT</span> <span class="nl">WorldRosItem</span> <span class="p">:</span> <span class="k">public</span> <span class="n">Item</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">);</span>
    
    <span class="n">WorldRosItem</span><span class="p">();</span>
    <span class="n">WorldRosItem</span><span class="p">(</span><span class="k">const</span> <span class="n">WorldRosItem</span><span class="o">&amp;</span> <span class="n">org</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">WorldRosItem</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">store</span><span class="p">(</span><span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">restore</span><span class="p">(</span><span class="k">const</span> <span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">start</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">stop</span><span class="p">();</span>
    
    <span class="kt">void</span> <span class="nf">setModuleName</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="n">Item</span><span class="o">*</span> <span class="n">doDuplicate</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">doPutProperties</span><span class="p">(</span><span class="n">PutPropertyFunction</span><span class="o">&amp;</span> <span class="n">putProperty</span><span class="p">);</span>
    
<span class="k">private</span><span class="o">:</span>
    <span class="n">WorldItemPtr</span> <span class="n">world</span><span class="p">;</span>
    <span class="n">SimulatorItemPtr</span> <span class="n">sim</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span> <span class="n">rosnode_</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="o">&gt;</span> <span class="n">async_ros_spin_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">CallbackQueue</span> <span class="n">rosqueue_</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">rosqueue_thread_</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">       The variable for managing registration to the simulator item.</span>
<span class="cm">       This registration that function of node creation at the simulation start,</span>
<span class="cm">       node deletion at the simulation stop.</span>
<span class="cm">     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">SimulatorItemPtr</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">registration_node_management_</span><span class="p">;</span>

    <span class="c1">/// The registration id of calling function from physics engine. (physics engine is SimulatorItem&#39;s subclass)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">post_dynamics_function_regid</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">queueThread</span><span class="p">();</span>

    <span class="cm">/**</span>
<span class="cm">      @brief Connect to event signal, function of nodes creation and deletion.</span>
<span class="cm">      The event signal is &#39;RootItem::instace()-&gt;sigTreeChanged()&#39;.</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">registrationNodeStartAndStop</span><span class="p">();</span>

    <span class="cm">/*</span>
<span class="cm">      For services and topics.</span>
<span class="cm">     */</span>

    <span class="c1">/// Update rate for publish clock.</span>
    <span class="kt">double</span> <span class="n">publish_clk_update_rate_</span><span class="p">;</span>
    <span class="c1">/// Update interval for publish clock.</span>
    <span class="kt">double</span> <span class="n">publish_clk_update_interval_</span><span class="p">;</span>
    <span class="c1">/// Publish next time for clock.</span>
    <span class="kt">double</span> <span class="n">publish_clk_next_time_</span><span class="p">;</span>

    <span class="c1">/// Update rate for publish link states.</span>
    <span class="kt">double</span> <span class="n">publish_ls_update_rate_</span><span class="p">;</span>
    <span class="c1">/// Update interval for publish link states.</span>
    <span class="kt">double</span> <span class="n">publish_ls_update_interval_</span><span class="p">;</span>
    <span class="c1">/// Publish next time for link states.</span>
    <span class="kt">double</span> <span class="n">publish_ls_next_time_</span><span class="p">;</span>

    <span class="c1">/// Update rate for publish model states.</span>
    <span class="kt">double</span> <span class="n">publish_ms_update_rate_</span><span class="p">;</span>
    <span class="c1">/// Update interval for publish model states.</span>
    <span class="kt">double</span> <span class="n">publish_ms_update_interval_</span><span class="p">;</span>
    <span class="c1">/// Publish next time for model states.</span>
    <span class="kt">double</span> <span class="n">publish_ms_next_time_</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">publishClock</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">publishLinkStates</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">publishModelStates</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="nf">resetSimulation</span><span class="p">(</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">pausePhysics</span><span class="p">(</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">unpausePhysics</span><span class="p">(</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">spawnModel</span><span class="p">(</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">deleteModel</span><span class="p">(</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">DeleteModel</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">DeleteModel</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span>     <span class="n">pub_clock_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span>     <span class="n">pub_link_states_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span>     <span class="n">pub_model_states_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">reset_simulation_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">reset_world_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">pause_physics_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">unpause_physics_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">spawn_vrml_model_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">spawn_urdf_model_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">spawn_sdf_model_service_</span><span class="p">;</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">ServiceServer</span> <span class="n">delete_model_service_</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">      For publish collision data. (contacts state)</span>
<span class="cm">     */</span>

    <span class="c1">/// Publisher of world contacts state. (link collisions pair)</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">Publisher</span> <span class="n">pub_world_contacts_state_</span><span class="p">;</span>
    <span class="c1">/// For getting collision data.</span>
    <span class="n">WorldRosSimulatorItemAccessor</span><span class="o">*</span> <span class="n">sim_access_</span><span class="p">;</span>

    <span class="c1">/// Update rate for publish contacts state.</span>
    <span class="kt">double</span> <span class="n">publish_cs_update_rate</span><span class="p">;</span>
    <span class="c1">/// Update interval for publish contacts state.</span>
    <span class="kt">double</span> <span class="n">publish_cs_update_interval</span><span class="p">;</span>
    <span class="c1">/// Publish next time for contacts state.</span>
    <span class="kt">double</span> <span class="n">publish_cs_next_time</span><span class="p">;</span>
    <span class="c1">/// Choose contacts state messages quiet or verbose.</span>
    <span class="kt">bool</span> <span class="n">is_csmsg_verbose</span><span class="p">;</span>

    <span class="c1">/// Publish this message.</span>
    <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">ContactsState</span> <span class="n">contacts_state</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">       @brief Publish link conatcts state.</span>
<span class="cm">       This information is the calculation result in the physics engine. (e.g. AISTSimulatorItem etc)</span>
<span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">publishContactsState</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">ref_ptr</span><span class="o">&lt;</span><span class="n">WorldRosItem</span><span class="o">&gt;</span> <span class="n">WorldRosItemPtr</span><span class="p">;</span>

<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* #ifndef CNOID_ROS_PLUGIN_WORLD_ROS_ITEM_H_INCLUDED */</span><span class="cp"></span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="worldrositem-cpp">
<h3>WorldRosItem.cpp<a class="headerlink" href="#worldrositem-cpp" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id41">
<div class="code-block-caption"><span class="caption-text">choreonoid_ros_pkg/choreonoid_plugins/src/WorldRosItem.cpp</span><a class="headerlink" href="#id41" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">   @file WorldRosItem.cpp</span>
<span class="cm">   @author</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&quot;WorldRosItem.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;BodyRosItem.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;cnoid/BodyItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/RootItem&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Link&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Sensor&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/ItemManager&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/MessageView&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/ItemTreeView&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/EigenUtil&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">cnoid</span><span class="p">;</span>

<span class="cp">#define DEBUG_WORLDROSITEM 0</span>

<span class="cm">/*</span>
<span class="cm">  Namepsace of parent of topics and services.</span>
<span class="cm">  NOTE: If you renaming, do not include &#39;-&#39;.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cnoidrospkg_parent_namespace_</span> <span class="o">=</span> <span class="s">&quot;choreonoid&quot;</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">ExtensionManager</span><span class="o">*</span> <span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ros</span><span class="o">::</span><span class="n">isInitialized</span><span class="p">())</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;choreonoid&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">registerClass</span><span class="o">&lt;</span><span class="n">WorldRosItem</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;WorldRosItem&quot;</span><span class="p">);</span>
    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">itemManager</span><span class="p">().</span><span class="n">addCreationPanel</span><span class="o">&lt;</span><span class="n">WorldRosItem</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">WorldRosItem</span><span class="o">::</span><span class="n">WorldRosItem</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">publish_clk_update_rate_</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
  <span class="n">publish_ls_update_rate_</span>  <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
  <span class="n">publish_ms_update_rate_</span>  <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
  <span class="n">publish_cs_update_rate</span>   <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
  <span class="n">is_csmsg_verbose</span>         <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

  <span class="n">RootItem</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sigTreeChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">registrationNodeStartAndStop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">WorldRosItem</span><span class="o">::</span><span class="n">WorldRosItem</span><span class="p">(</span><span class="k">const</span> <span class="n">WorldRosItem</span><span class="o">&amp;</span> <span class="n">org</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Item</span><span class="p">(</span><span class="n">org</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">publish_clk_update_rate_</span> <span class="o">=</span> <span class="n">org</span><span class="p">.</span><span class="n">publish_clk_update_rate_</span><span class="p">;</span>
  <span class="n">publish_ls_update_rate_</span>  <span class="o">=</span> <span class="n">org</span><span class="p">.</span><span class="n">publish_ls_update_rate_</span><span class="p">;</span>
  <span class="n">publish_ms_update_rate_</span>  <span class="o">=</span> <span class="n">org</span><span class="p">.</span><span class="n">publish_ms_update_rate_</span><span class="p">;</span>
  <span class="n">publish_cs_update_rate</span>   <span class="o">=</span> <span class="n">org</span><span class="p">.</span><span class="n">publish_cs_update_rate</span><span class="p">;</span>
  <span class="n">is_csmsg_verbose</span>         <span class="o">=</span> <span class="n">org</span><span class="p">.</span><span class="n">is_csmsg_verbose</span><span class="p">;</span>

  <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

  <span class="n">RootItem</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sigTreeChanged</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">registrationNodeStartAndStop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">WorldRosItem</span><span class="o">::~</span><span class="n">WorldRosItem</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">stop</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">store</span><span class="p">(</span><span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;publishClockUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_clk_update_rate_</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;publishLinkStatesUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_ls_update_rate_</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;publishModelStatesUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_ms_update_rate_</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;publishContactsStateUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_cs_update_rate</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;contactsStateMessagesVerbose&quot;</span><span class="p">,</span> <span class="n">is_csmsg_verbose</span><span class="p">);</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">restore</span><span class="p">(</span><span class="k">const</span> <span class="n">Archive</span><span class="o">&amp;</span> <span class="n">archive</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;publishClockUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_clk_update_rate_</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;publishLinkStatesUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_ls_update_rate_</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;publishModelStatesUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_ms_update_rate_</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;publishContactsStateUpdateRate&quot;</span><span class="p">,</span> <span class="n">publish_cs_update_rate</span><span class="p">);</span>
  <span class="n">archive</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;contactsStateMessagesVerbose&quot;</span><span class="p">,</span> <span class="n">is_csmsg_verbose</span><span class="p">);</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Item</span><span class="o">*</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">doDuplicate</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">WorldRosItem</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">doPutProperties</span><span class="p">(</span><span class="n">PutPropertyFunction</span><span class="o">&amp;</span> <span class="n">putProperty</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">putProperty</span><span class="p">.</span><span class="n">decimals</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)(</span><span class="s">&quot;Publish clock update rate&quot;</span><span class="p">,</span> <span class="n">publish_clk_update_rate_</span><span class="p">,</span>
                                    <span class="n">changeProperty</span><span class="p">(</span><span class="n">publish_clk_update_rate_</span><span class="p">));</span>
  <span class="n">putProperty</span><span class="p">.</span><span class="n">decimals</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)(</span><span class="s">&quot;Publish link states update rate&quot;</span><span class="p">,</span> <span class="n">publish_ls_update_rate_</span><span class="p">,</span>
                                    <span class="n">changeProperty</span><span class="p">(</span><span class="n">publish_ls_update_rate_</span><span class="p">));</span>
  <span class="n">putProperty</span><span class="p">.</span><span class="n">decimals</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)(</span><span class="s">&quot;Publish model states update rate&quot;</span><span class="p">,</span> <span class="n">publish_ms_update_rate_</span><span class="p">,</span>
                                    <span class="n">changeProperty</span><span class="p">(</span><span class="n">publish_ms_update_rate_</span><span class="p">));</span>
  <span class="n">putProperty</span><span class="p">.</span><span class="n">decimals</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)(</span><span class="s">&quot;Publish contacts state update rate&quot;</span><span class="p">,</span> <span class="n">publish_cs_update_rate</span><span class="p">,</span>
                                    <span class="n">changeProperty</span><span class="p">(</span><span class="n">publish_cs_update_rate</span><span class="p">));</span>
  <span class="n">putProperty</span><span class="p">(</span><span class="s">&quot;Make contacts state messages verbose&quot;</span><span class="p">,</span> <span class="n">is_csmsg_verbose</span><span class="p">,</span> <span class="n">changeProperty</span><span class="p">(</span><span class="n">is_csmsg_verbose</span><span class="p">));</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishContactsState</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">CollisionLinkPairListPtr</span> <span class="n">collision_pairs</span><span class="p">;</span>
  <span class="kt">size_t</span>                   <span class="n">i</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sim_access_</span> <span class="o">||</span> <span class="o">!</span> <span class="n">sim_access_</span><span class="o">-&gt;</span><span class="n">get_collisions</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">collision_pairs</span> <span class="o">=</span> <span class="n">sim_access_</span><span class="o">-&gt;</span><span class="n">get_collisions</span><span class="p">();</span>
  <span class="n">i</span>               <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">CollisionLinkPairList</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">collision_pairs</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">collision_pairs</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">ContactState</span> <span class="n">dst</span><span class="p">;</span>
    <span class="n">CollisionLinkPairPtr</span>      <span class="n">p</span>       <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
    <span class="kt">size_t</span>                    <span class="n">cols_sz</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">collisions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

    <span class="n">dst</span><span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="s">&quot;world:</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">      Copy results of link pairs name.</span>
<span class="cm">     */</span>
    <span class="n">dst</span><span class="p">.</span><span class="n">collision1_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;::&quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;::collision&quot;</span><span class="p">;</span>
    <span class="n">dst</span><span class="p">.</span><span class="n">collision2_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;::&quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;::collision&quot;</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">      Copy results of force and torque.</span>
<span class="cm">     */</span>
    <span class="n">DyLink</span><span class="o">*</span> <span class="n">dylink</span><span class="p">;</span>
    <span class="kt">size_t</span>  <span class="n">wrch_sz</span><span class="p">;</span>

    <span class="n">dylink</span>  <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">DyLink</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">wrch_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dylink</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">wrch_sz</span> <span class="o">+=</span> <span class="n">dylink</span><span class="o">-&gt;</span><span class="n">constraintForces</span><span class="p">().</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">wrch_sz</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wrch_sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Vector3</span> <span class="n">total_force</span><span class="p">(</span><span class="n">Vector3</span><span class="o">::</span><span class="n">Zero</span><span class="p">());</span>
      <span class="n">Vector3</span> <span class="nf">total_torque</span><span class="p">(</span><span class="n">Vector3</span><span class="o">::</span><span class="n">Zero</span><span class="p">());</span>
      <span class="kt">size_t</span>  <span class="n">wrch_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">dylink</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Matrix3</span>                       <span class="n">frame_rrot</span><span class="p">(</span><span class="n">Matrix3</span><span class="p">(</span><span class="n">dylink</span><span class="o">-&gt;</span><span class="n">R</span><span class="p">().</span><span class="n">inverse</span><span class="p">()));</span>
        <span class="n">DyLink</span><span class="o">::</span><span class="n">ConstraintForceArray</span><span class="o">&amp;</span> <span class="n">cfa</span> <span class="o">=</span> <span class="n">dylink</span><span class="o">-&gt;</span><span class="n">constraintForces</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">cfa_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cfa_idx</span> <span class="o">&lt;</span> <span class="n">cfa</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">cfa_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">Vector3</span> <span class="n">force</span> <span class="o">=</span> <span class="n">frame_rrot</span> <span class="o">*</span> <span class="n">cfa</span><span class="p">[</span><span class="n">cfa_idx</span><span class="p">].</span><span class="n">force</span><span class="p">;</span>
          <span class="n">Vector3</span> <span class="n">tau</span>   <span class="o">=</span> <span class="n">frame_rrot</span> <span class="o">*</span>
                            <span class="p">(</span><span class="n">cfa</span><span class="p">[</span><span class="n">cfa_idx</span><span class="p">].</span><span class="n">point</span><span class="p">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cfa</span><span class="p">[</span><span class="n">cfa_idx</span><span class="p">].</span><span class="n">force</span><span class="p">)</span> <span class="o">-</span> <span class="n">dylink</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">().</span><span class="n">cross</span><span class="p">(</span><span class="n">cfa</span><span class="p">[</span><span class="n">cfa_idx</span><span class="p">].</span><span class="n">force</span><span class="p">));</span>

          <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">[</span><span class="n">wrch_idx</span><span class="p">].</span><span class="n">force</span><span class="p">.</span><span class="n">x</span>  <span class="o">=</span> <span class="n">force</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">[</span><span class="n">wrch_idx</span><span class="p">].</span><span class="n">force</span><span class="p">.</span><span class="n">y</span>  <span class="o">=</span> <span class="n">force</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">[</span><span class="n">wrch_idx</span><span class="p">].</span><span class="n">force</span><span class="p">.</span><span class="n">z</span>  <span class="o">=</span> <span class="n">force</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
          <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">[</span><span class="n">wrch_idx</span><span class="p">].</span><span class="n">torque</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">[</span><span class="n">wrch_idx</span><span class="p">].</span><span class="n">torque</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">dst</span><span class="p">.</span><span class="n">wrenches</span><span class="p">[</span><span class="n">wrch_idx</span><span class="p">].</span><span class="n">torque</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">tau</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

          <span class="n">wrch_idx</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">total_force</span>  <span class="o">=</span> <span class="n">frame_rrot</span> <span class="o">*</span> <span class="n">dylink</span><span class="o">-&gt;</span><span class="n">f_ext</span><span class="p">();</span>
        <span class="n">total_torque</span> <span class="o">=</span> <span class="n">frame_rrot</span> <span class="o">*</span> <span class="p">(</span><span class="n">dylink</span><span class="o">-&gt;</span><span class="n">tau_ext</span><span class="p">()</span> <span class="o">-</span> <span class="n">dylink</span><span class="o">-&gt;</span><span class="n">wc</span><span class="p">().</span><span class="n">cross</span><span class="p">(</span><span class="n">dylink</span><span class="o">-&gt;</span><span class="n">f_ext</span><span class="p">()));</span>
      <span class="p">}</span>

      <span class="n">dst</span><span class="p">.</span><span class="n">total_wrench</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">x</span>  <span class="o">=</span> <span class="n">total_force</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">total_wrench</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">y</span>  <span class="o">=</span> <span class="n">total_force</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">total_wrench</span><span class="p">.</span><span class="n">force</span><span class="p">.</span><span class="n">z</span>  <span class="o">=</span> <span class="n">total_force</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">total_wrench</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">total_torque</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">total_wrench</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">total_torque</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">total_wrench</span><span class="p">.</span><span class="n">torque</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">total_torque</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">      Copy results of position and normal and depth.</span>
<span class="cm">     */</span>
    <span class="n">dst</span><span class="p">.</span><span class="n">contact_positions</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">cols_sz</span><span class="p">);</span>
    <span class="n">dst</span><span class="p">.</span><span class="n">contact_normals</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">cols_sz</span><span class="p">);</span>
    <span class="n">dst</span><span class="p">.</span><span class="n">depths</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">cols_sz</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cols_sz</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Collision</span><span class="o">*</span> <span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">collisions</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>

      <span class="n">dst</span><span class="p">.</span><span class="n">contact_positions</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">contact_positions</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">contact_positions</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">z</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">contact_normals</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">x</span>   <span class="o">=</span> <span class="o">-</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">contact_normals</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">y</span>   <span class="o">=</span> <span class="o">-</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">contact_normals</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">z</span>   <span class="o">=</span> <span class="o">-</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">depths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>              <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_csmsg_verbose</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dst</span><span class="p">.</span><span class="n">info</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot; number of collision pairs:(&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span>
                   <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">collision_pairs</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;) my geom:</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">dst</span><span class="p">.</span><span class="n">collision1_name</span> <span class="o">+</span>
                   <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> other geom:</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">dst</span><span class="p">.</span><span class="n">collision2_name</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> wrenches/contacts:(&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">wrch_sz</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">cols_sz</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">dst</span><span class="p">.</span><span class="n">info</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot; time:&quot;</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">()));</span>

    <span class="n">contacts_state</span><span class="p">.</span><span class="n">states</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">publish_cs_next_time</span> <span class="o">&lt;=</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">rosgraph_msgs</span><span class="o">::</span><span class="n">Clock</span> <span class="n">tm</span><span class="p">;</span>

    <span class="n">tm</span><span class="p">.</span><span class="n">clock</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>

    <span class="n">contacts_state</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">sec</span>  <span class="o">=</span> <span class="n">tm</span><span class="p">.</span><span class="n">clock</span><span class="p">.</span><span class="n">sec</span><span class="p">;</span>
    <span class="n">contacts_state</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span><span class="p">.</span><span class="n">nsec</span> <span class="o">=</span> <span class="n">tm</span><span class="p">.</span><span class="n">clock</span><span class="p">.</span><span class="n">nsec</span><span class="p">;</span>

    <span class="n">pub_world_contacts_state_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">contacts_state</span><span class="p">);</span>
    <span class="n">contacts_state</span><span class="p">.</span><span class="n">states</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">publish_cs_next_time</span> <span class="o">+=</span> <span class="n">publish_cs_update_interval</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">registrationNodeStartAndStop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">WorldItemPtr</span> <span class="n">parent</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">SimulatorItemPtr</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">parent</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findOwnerItem</span><span class="o">&lt;</span><span class="n">WorldItem</span><span class="o">&gt;</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">Item</span><span class="o">*</span> <span class="n">child</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">childItem</span><span class="p">();</span> <span class="n">child</span><span class="p">;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">nextItem</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SimulatorItemPtr</span> <span class="n">p</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">SimulatorItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">isRunning</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">sigSimulationStarted</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">sigSimulationFinished</span><span class="p">().</span><span class="n">connect</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>

        <span class="n">registration_node_management_</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">();</span>
<span class="cp">#if (DEBUG_WORLDROSITEM &gt; 0)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">registration_node_management_</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: regsitered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: already registered&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="cp">#endif  </span><span class="cm">/* (DEBUG_WORLDROSITEM &gt; 0) */</span><span class="cp"></span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">world</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">findOwnerItem</span><span class="o">&lt;</span><span class="n">WorldItem</span><span class="o">&gt;</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">sim</span> <span class="o">=</span> <span class="n">SimulatorItem</span><span class="o">::</span><span class="n">findActiveSimulatorItemFor</span><span class="p">(</span><span class="k">this</span><span class="p">)))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Found WorldItem: %s&quot;</span><span class="p">,</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="n">ROS_DEBUG</span><span class="p">(</span><span class="s">&quot;Found SimulatorItem: %s&quot;</span><span class="p">,</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>

  <span class="n">rosnode_</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="p">(</span><span class="n">cnoidrospkg_parent_namespace_</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">publish_clk_update_rate_</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">publish_clk_update_rate_</span> <span class="o">&lt;=</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pub_clock_</span>                   <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">rosgraph_msgs</span><span class="o">::</span><span class="n">Clock</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;/clock&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">publish_clk_update_interval_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">publish_clk_update_rate_</span><span class="p">;</span>
    <span class="n">publish_clk_next_time_</span>       <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
      <span class="n">sim</span><span class="o">-&gt;</span><span class="n">addPostDynamicsFunction</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishClock</span><span class="p">,</span> <span class="k">this</span><span class="p">)));</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">publish_ls_update_rate_</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">publish_ls_update_rate_</span> <span class="o">&lt;=</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pub_link_states_</span>            <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">LinkStates</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;link_states&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">publish_ls_update_interval_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">publish_ls_update_rate_</span><span class="p">;</span>
    <span class="n">publish_ls_next_time_</span>       <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
      <span class="n">sim</span><span class="o">-&gt;</span><span class="n">addPostDynamicsFunction</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishLinkStates</span><span class="p">,</span> <span class="k">this</span><span class="p">)));</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">publish_ms_update_rate_</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">publish_ms_update_rate_</span> <span class="o">&lt;=</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pub_model_states_</span>           <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">ModelStates</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;model_states&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">publish_ms_update_interval_</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">publish_ms_update_rate_</span><span class="p">;</span>
    <span class="n">publish_ms_next_time_</span>       <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
      <span class="n">sim</span><span class="o">-&gt;</span><span class="n">addPostDynamicsFunction</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishModelStates</span><span class="p">,</span> <span class="k">this</span><span class="p">)));</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">publish_cs_update_rate</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">publish_cs_update_rate</span> <span class="o">&lt;=</span> <span class="mf">1000.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">topic_name</span> <span class="o">=</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;/physics/contacts&quot;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">topic_name</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">topic_name</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>

    <span class="n">pub_world_contacts_state_</span>  <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">ContactsState</span><span class="o">&gt;</span><span class="p">(</span><span class="n">topic_name</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">sim_access_</span>                <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">WorldRosSimulatorItemAccessor</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">sim</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
    <span class="n">publish_cs_update_interval</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">publish_cs_update_rate</span><span class="p">;</span>
    <span class="n">publish_cs_next_time</span>       <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
      <span class="n">sim</span><span class="o">-&gt;</span><span class="n">addPostDynamicsFunction</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishContactsState</span><span class="p">,</span> <span class="k">this</span><span class="p">)));</span>

    <span class="n">AISTSimulatorItem</span><span class="o">*</span> <span class="n">aist_sim</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">aist_sim</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">AISTSimulatorItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">sim</span><span class="p">.</span><span class="n">get</span><span class="p">())))</span> <span class="p">{</span>
      <span class="n">aist_sim</span><span class="o">-&gt;</span><span class="n">setConstraintForceOutputEnabled</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">contacts_state</span><span class="p">.</span><span class="n">states</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">pause_physics_service_name</span><span class="p">(</span><span class="s">&quot;pause_physics&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">pause_physics_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;</span><span class="p">(</span>
                                                          <span class="n">pause_physics_service_name</span><span class="p">,</span>
                                                          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">pausePhysics</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                          <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">pause_physics_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">pause_physics_aso</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">unpause_physics_service_name</span><span class="p">(</span><span class="s">&quot;unpause_physics&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">unpause_physics_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;</span><span class="p">(</span>
                                                          <span class="n">unpause_physics_service_name</span><span class="p">,</span>
                                                          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">unpausePhysics</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                          <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">unpause_physics_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">unpause_physics_aso</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">reset_simulation_service_name</span><span class="p">(</span><span class="s">&quot;reset_simulation&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">reset_simulation_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">&gt;</span><span class="p">(</span>
                                                          <span class="n">reset_simulation_service_name</span><span class="p">,</span>
                                                          <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">resetSimulation</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                          <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">reset_simulation_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">reset_simulation_aso</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">spawn_vrml_model_service_name</span><span class="p">(</span><span class="s">&quot;spawn_vrml_model&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">spawn_vrml_model_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">&gt;</span><span class="p">(</span>
                                                                  <span class="n">spawn_vrml_model_service_name</span><span class="p">,</span>
                                                                  <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">spawnModel</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                                  <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">spawn_vrml_model_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">spawn_vrml_model_aso</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">spawn_urdf_model_service_name</span><span class="p">(</span><span class="s">&quot;spawn_urdf_model&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">spawn_urdf_model_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">&gt;</span><span class="p">(</span>
                                                                  <span class="n">spawn_urdf_model_service_name</span><span class="p">,</span>
                                                                  <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">spawnModel</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                                  <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">spawn_urdf_model_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">spawn_urdf_model_aso</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">spawn_sdf_model_service_name</span><span class="p">(</span><span class="s">&quot;spawn_sdf_model&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">spawn_sdf_model_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">&gt;</span><span class="p">(</span>
                                                                  <span class="n">spawn_sdf_model_service_name</span><span class="p">,</span>
                                                                  <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">spawnModel</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                                  <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">spawn_sdf_model_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">spawn_sdf_model_aso</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">delete_model_service_name</span><span class="p">(</span><span class="s">&quot;delete_model&quot;</span><span class="p">);</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span> <span class="n">delete_aso</span> <span class="o">=</span>
    <span class="n">ros</span><span class="o">::</span><span class="n">AdvertiseServiceOptions</span><span class="o">::</span><span class="n">create</span><span class="o">&lt;</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">DeleteModel</span><span class="o">&gt;</span><span class="p">(</span>
                                                                   <span class="n">delete_model_service_name</span><span class="p">,</span>
                                                                   <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">deleteModel</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">_1</span><span class="p">,</span><span class="n">_2</span><span class="p">),</span>
                                                                   <span class="n">ros</span><span class="o">::</span><span class="n">VoidPtr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">rosqueue_</span><span class="p">);</span>
  <span class="n">delete_model_service_</span> <span class="o">=</span> <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">advertiseService</span><span class="p">(</span><span class="n">delete_aso</span><span class="p">);</span>

  <span class="n">async_ros_spin_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ros</span><span class="o">::</span><span class="n">AsyncSpinner</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>

  <span class="n">rosqueue_thread_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WorldRosItem</span><span class="o">::</span><span class="n">queueThread</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishClock</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">publish_clk_next_time_</span> <span class="o">&gt;</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">rosgraph_msgs</span><span class="o">::</span><span class="n">Clock</span> <span class="n">ros_time_</span><span class="p">;</span>

  <span class="n">ros_time_</span><span class="p">.</span><span class="n">clock</span><span class="p">.</span><span class="n">fromSec</span><span class="p">(</span><span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">());</span>
  <span class="n">pub_clock_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">ros_time_</span><span class="p">);</span>
  <span class="n">publish_clk_next_time_</span> <span class="o">+=</span> <span class="n">publish_clk_update_interval_</span><span class="p">;</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishLinkStates</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">publish_ls_next_time_</span> <span class="o">&gt;</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">LinkStates</span> <span class="n">link_states</span><span class="p">;</span>

  <span class="n">Item</span><span class="o">*</span> <span class="n">item</span> <span class="o">=</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">childItem</span><span class="p">();</span>
  <span class="k">while</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BodyItem</span><span class="o">*</span> <span class="n">body</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">BodyItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">numLinks</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Link</span><span class="o">*</span> <span class="n">link</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">link_states</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;::&quot;</span> <span class="o">+</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">());</span>
        <span class="n">Vector3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">translation</span><span class="p">();</span>
        <span class="n">Quaternion</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">());</span>
        <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Pose</span> <span class="n">pose</span><span class="p">;</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">w</span><span class="p">();</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">y</span><span class="p">();</span>
        <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
        <span class="n">link_states</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
        <span class="cm">/*</span>
<span class="cm">        twist.linear.x = linear_vel.x;</span>
<span class="cm">        twist.linear.y = linear_vel.y;</span>
<span class="cm">        twist.linear.z = linear_vel.z;</span>
<span class="cm">        twist.angular.x = angular_vel.x;</span>
<span class="cm">        twist.angular.y = angular_vel.y;</span>
<span class="cm">        twist.angular.z = angular_vel.z;</span>
<span class="cm">        link_states.twist.push_back(twist);</span>
<span class="cm">        */</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">nextItem</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">pub_link_states_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">link_states</span><span class="p">);</span>
  <span class="n">publish_ls_next_time_</span> <span class="o">+=</span> <span class="n">publish_ls_update_interval_</span><span class="p">;</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">publishModelStates</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">publish_ms_next_time_</span> <span class="o">&gt;</span> <span class="n">sim</span><span class="o">-&gt;</span><span class="n">currentTime</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">ModelStates</span> <span class="n">model_states</span><span class="p">;</span>

  <span class="n">Item</span><span class="o">*</span> <span class="n">item</span> <span class="o">=</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">childItem</span><span class="p">();</span>
  <span class="k">while</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BodyItem</span><span class="o">*</span> <span class="n">body</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">BodyItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">model_states</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">());</span>
      <span class="n">Link</span><span class="o">*</span> <span class="n">link</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">rootLink</span><span class="p">();</span>
      <span class="n">Vector3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">translation</span><span class="p">();</span>
      <span class="n">Quaternion</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">rotation</span><span class="p">());</span>
      <span class="n">geometry_msgs</span><span class="o">::</span><span class="n">Pose</span> <span class="n">pose</span><span class="p">;</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pos</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">w</span><span class="p">();</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">y</span><span class="p">();</span>
      <span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">rot</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
      <span class="n">model_states</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pose</span><span class="p">);</span>
      <span class="cm">/*</span>
<span class="cm">      twist.linear.x = linear_vel.x;</span>
<span class="cm">      twist.linear.y = linear_vel.y;</span>
<span class="cm">      twist.linear.z = linear_vel.z;</span>
<span class="cm">      twist.angular.x = angular_vel.x;</span>
<span class="cm">      twist.angular.y = angular_vel.y;</span>
<span class="cm">      twist.angular.z = angular_vel.z;</span>
<span class="cm">      model_states.twist.push_back(twist);</span>
<span class="cm">      */</span>
    <span class="p">}</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">nextItem</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">pub_model_states_</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">model_states</span><span class="p">);</span>
  <span class="n">publish_ms_next_time_</span> <span class="o">+=</span> <span class="n">publish_ms_update_interval_</span><span class="p">;</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">queueThread</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">double</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">rosqueue_</span><span class="p">.</span><span class="n">callAvailable</span><span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">WallDuration</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">pausePhysics</span><span class="p">(</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sim</span><span class="o">-&gt;</span><span class="n">pauseSimulation</span><span class="p">();</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">unpausePhysics</span><span class="p">(</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sim</span><span class="o">-&gt;</span><span class="n">restartSimulation</span><span class="p">();</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">resetSimulation</span><span class="p">(</span><span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">std_srvs</span><span class="o">::</span><span class="n">Empty</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sim</span><span class="o">-&gt;</span><span class="n">startSimulation</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">spawnModel</span><span class="p">(</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span>
                              <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">SpawnModel</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">model_name</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">model_xml</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">model_xml</span><span class="p">;</span>

  <span class="n">cnoid</span><span class="o">::</span><span class="n">Vector3</span> <span class="n">trans</span><span class="p">;</span>
  <span class="n">cnoid</span><span class="o">::</span><span class="n">Quaternion</span> <span class="n">R</span><span class="p">;</span>
  <span class="n">trans</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
  <span class="n">trans</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
  <span class="n">trans</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
  <span class="n">R</span><span class="p">.</span><span class="n">w</span><span class="p">()</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
  <span class="n">R</span><span class="p">.</span><span class="n">x</span><span class="p">()</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
  <span class="n">R</span><span class="p">.</span><span class="n">y</span><span class="p">()</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
  <span class="n">R</span><span class="p">.</span><span class="n">z</span><span class="p">()</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">initial_pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

  <span class="n">BodyItemPtr</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BodyItem</span><span class="p">();</span>
  <span class="n">body</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">model_name</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">    Load model file.</span>
<span class="cm">   */</span>

  <span class="kt">char</span> <span class="n">tmpfname</span><span class="p">[</span><span class="n">L_tmpnam</span><span class="p">];</span>
  <span class="kt">bool</span> <span class="n">is_loaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">memset</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">));</span>
  <span class="n">strncpy</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">,</span> <span class="s">&quot;cnoid_ros_pkgXXXXXX&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">ofs</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">);</span>
    <span class="n">ofs</span> <span class="o">&lt;&lt;</span> <span class="n">model_xml</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">ofs</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
    <span class="n">ofs</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">is_loaded</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">loadModelFile</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">);</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">tmpfname</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">is_loaded</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">    Spawn model to simulation world.</span>
<span class="cm">   */</span>

  <span class="n">body</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">rootLink</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setTranslation</span><span class="p">(</span><span class="n">trans</span><span class="p">);</span>
  <span class="n">body</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">rootLink</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setRotation</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">matrix</span><span class="p">());</span>
  <span class="n">world</span><span class="o">-&gt;</span><span class="n">addChildItem</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>

  <span class="n">BodyRosItemPtr</span> <span class="n">bodyros</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BodyRosItem</span><span class="p">();</span>
  <span class="n">bodyros</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s">&quot;_ROS&quot;</span><span class="p">);</span>
  <span class="n">body</span><span class="o">-&gt;</span><span class="n">addChildItem</span><span class="p">(</span><span class="n">bodyros</span><span class="p">);</span>
  
  <span class="n">ItemTreeView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">checkItem</span><span class="p">(</span><span class="n">body</span><span class="p">);</span>
  <span class="n">ItemTreeView</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">checkItem</span><span class="p">(</span><span class="n">bodyros</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">deleteModel</span><span class="p">(</span><span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">DeleteModel</span><span class="o">::</span><span class="n">Request</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span>
                               <span class="n">gazebo_msgs</span><span class="o">::</span><span class="n">DeleteModel</span><span class="o">::</span><span class="n">Response</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ItemPtr</span> <span class="n">item</span> <span class="o">=</span> <span class="n">world</span><span class="o">-&gt;</span><span class="n">findItem</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">model_name</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;DeleteModel: model [%s] does not exist&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">.</span><span class="n">model_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">res</span><span class="p">.</span><span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">res</span><span class="p">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="s">&quot;DeleteModel: model does not exist&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">item</span><span class="o">-&gt;</span><span class="n">detachFromParentItem</span><span class="p">();</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">sim</span><span class="o">-&gt;</span><span class="n">removePostDynamicsFunction</span><span class="p">(</span><span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
    <span class="n">post_dynamics_function_regid</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ros</span><span class="o">::</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rosqueue_</span><span class="p">.</span><span class="n">isEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">rosqueue_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">async_ros_spin_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">async_ros_spin_</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rosnode_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">rosnode_</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">rosqueue_thread_</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rosqueue_thread_</span><span class="o">-&gt;</span><span class="n">join</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">registration_node_management_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="rosbodyplugin-cpp">
<h3>RosBodyPlugin.cpp<a class="headerlink" href="#rosbodyplugin-cpp" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id42">
<div class="code-block-caption"><span class="caption-text">choreonoid_ros_pkg/choreonoid_plugins/src/RosBodyPlugin.cpp</span><a class="headerlink" href="#id42" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">  @file</span>
<span class="cm">  @author</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&quot;BodyRosItem.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;BodyRosTorqueControllerItem.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;BodyRosHighgainControllerItem.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;WorldRosItem.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cnoid/Plugin&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">cnoid</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RosBodyPlugin</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Plugin</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">RosBodyPlugin</span><span class="p">()</span> <span class="o">:</span> <span class="n">Plugin</span><span class="p">(</span><span class="s">&quot;RosBody&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
  
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">BodyRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">BodyRosTorqueControllerItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">BodyRosHighgainControllerItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">WorldRosItem</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">CNOID_IMPLEMENT_PLUGIN_ENTRY</span><span class="p">(</span><span class="n">RosBodyPlugin</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="cmakelists-txt">
<h3>CMakeLists.txt<a class="headerlink" href="#cmakelists-txt" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="literal-block-wrapper docutils container" id="id43">
<div class="code-block-caption"><span class="caption-text">choreonoid_ros_pkg/choreonoid_plugins/CMakeLists.txt</span><a class="headerlink" href="#id43" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cmake"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>

<span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.8.3</span><span class="p">)</span>
<span class="nb">cmake_policy</span><span class="p">(</span><span class="s">VERSION</span> <span class="o">${</span><span class="nv">CMAKE_MINIMUM_REQUIRED_VERSION</span><span class="o">}</span><span class="p">)</span>

<span class="nb">if</span> <span class="p">(</span><span class="s">CMAKE_VERSION</span> <span class="s">VERSION_GREATER</span> <span class="s2">&quot;2.9.9.9&quot;</span><span class="p">)</span>
  <span class="nb">cmake_policy</span><span class="p">(</span><span class="s">SET</span> <span class="s">CMP0037</span> <span class="s">OLD</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">project</span><span class="p">(</span><span class="s">choreonoid_plugins</span><span class="p">)</span>

<span class="c"># NOTE: if you chosen the CMake build type with not set optimize option of compiler,</span>
<span class="c"># the depth camera device process very slowly.</span>
<span class="nb">if</span><span class="p">(</span><span class="s">NOT</span> <span class="s">CMAKE_BUILD_TYPE</span><span class="p">)</span>
  <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_BUILD_TYPE</span> <span class="s">Release</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">find_package</span><span class="p">(</span><span class="s">catkin</span> <span class="s">REQUIRED</span> <span class="s">COMPONENTS</span> 
  <span class="s">choreonoid_ros</span>
  <span class="s">message_generation</span> 
  <span class="s">roscpp</span> 
  <span class="s">rospy</span> 
  <span class="s">nodelet</span> 
  <span class="s">angles</span> 
  <span class="s">std_srvs</span> 
  <span class="s">gazebo_msgs</span> 
  <span class="s">geometry_msgs</span> 
  <span class="s">sensor_msgs</span> 
  <span class="s">nav_msgs</span> 
  <span class="s">tf</span> 
  <span class="s">tf2_ros</span> 
  <span class="s">dynamic_reconfigure</span> 
  <span class="s">driver_base</span> 
  <span class="s">rosgraph_msgs</span> 
  <span class="s">trajectory_msgs</span> 
  <span class="s">image_transport</span> 
  <span class="s">rosconsole</span>
  <span class="s">cv_bridge</span>
  <span class="s">polled_camera</span>
  <span class="s">diagnostic_updater</span>
  <span class="s">camera_info_manager</span>
<span class="p">)</span>

<span class="nb">include</span> <span class="p">(</span><span class="s">FindPkgConfig</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">ENV{PKG_CONFIG_PATH}</span> <span class="s2">&quot;$ENV{PKG_CONFIG_PATH}:${CATKIN_DEVEL_PREFIX}/lib/pkgconfig&quot;</span><span class="p">)</span>
<span class="nb">if</span> <span class="p">(</span><span class="s">PKG_CONFIG_FOUND</span><span class="p">)</span>
  <span class="nb">pkg_check_modules</span><span class="p">(</span><span class="s">CNOID</span> <span class="s">REQUIRED</span> <span class="s">choreonoid</span><span class="p">)</span>
<span class="nb">else</span><span class="p">()</span>
  <span class="nb">message</span><span class="p">(</span><span class="s">FATAL_ERROR</span> <span class="s2">&quot;pkg-config is required; please install it&quot;</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">execute_process</span><span class="p">(</span><span class="s">COMMAND</span> <span class="o">${</span><span class="nv">PKG_CONFIG_EXECUTABLE</span><span class="o">}</span> <span class="s">--variable=plugindir</span> <span class="s">choreonoid</span>
                    <span class="s">OUTPUT_VARIABLE</span> <span class="s">CNOID_PLUGIN_SUBDIR</span>
                    <span class="s">OUTPUT_STRIP_TRAILING_WHITESPACE</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">Boost_USE_STATIC_LIBS</span> <span class="s">OFF</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">Boost_ADDITIONAL_VERSIONS</span> <span class="s2">&quot;1.42&quot;</span> <span class="s2">&quot;1.42.0&quot;</span> <span class="s2">&quot;1.43&quot;</span> <span class="s2">&quot;1.43.0&quot;</span> <span class="s2">&quot;1.44&quot;</span> <span class="s2">&quot;1.44.0&quot;</span> <span class="s2">&quot;1.45&quot;</span> <span class="s2">&quot;1.45.0&quot;</span> <span class="s2">&quot;1.46&quot;</span> <span class="s2">&quot;1.46.0&quot;</span> <span class="s2">&quot;1.46.1&quot;</span> <span class="s2">&quot;1.47&quot;</span> <span class="s2">&quot;1.47.0&quot;</span> <span class="s2">&quot;1.48&quot;</span> <span class="s2">&quot;1.48.0&quot;</span> <span class="s2">&quot;1.49.0&quot;</span> <span class="s2">&quot;1.50.0&quot;</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span><span class="s">boost_packages</span> <span class="s">system</span> <span class="s">filesystem</span> <span class="s">program_options</span> <span class="s">regex</span> <span class="s">thread</span> <span class="s">iostreams</span> <span class="s">date_time</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="s">1.36.0</span> <span class="s">REQUIRED</span> <span class="s">COMPONENTS</span> <span class="o">${</span><span class="nv">boost_packages</span><span class="o">}</span><span class="p">)</span>

<span class="nb">include_directories</span><span class="p">(</span>
  <span class="o">${</span><span class="nv">Boost_INCLUDE_DIRS</span><span class="o">}</span>
  <span class="o">${</span><span class="nv">catkin_INCLUDE_DIRS</span><span class="o">}</span>
  <span class="o">${</span><span class="nv">CNOID_INCLUDE_DIRS</span><span class="o">}</span>
  <span class="o">${</span><span class="nv">EIGEN_INCLUDE_DIRS</span><span class="o">}</span>
<span class="p">)</span>

<span class="nb">link_directories</span><span class="p">(</span>
  <span class="o">${</span><span class="nv">CNOID_LIBRARY_DIRS</span><span class="o">}</span>
  <span class="o">${</span><span class="nv">Boost_LIBRARY_DIRS</span><span class="o">}</span>
<span class="p">)</span>

<span class="nb">catkin_package</span><span class="p">(</span>
  <span class="s">LIBRARIES</span>
  <span class="s">CnoidRosBodyPlugin</span>
  <span class="s">INCLUDE_DIRS</span>
  <span class="s">src</span>
  <span class="s">CATKIN_DEPENDS</span>
  <span class="s">message_generation</span> 
  <span class="s">roscpp</span> 
  <span class="s">rospy</span> 
  <span class="s">nodelet</span> 
  <span class="s">angles</span> 
  <span class="s">std_srvs</span> 
  <span class="s">gazebo_msgs</span> 
  <span class="s">geometry_msgs</span> 
  <span class="s">sensor_msgs</span> 
  <span class="s">nav_msgs</span> 
  <span class="s">tf</span> 
  <span class="s">tf2_ros</span>
  <span class="s">dynamic_reconfigure</span> 
  <span class="s">driver_base</span> 
  <span class="s">rosgraph_msgs</span> 
  <span class="s">trajectory_msgs</span> 
  <span class="s">image_transport</span> 
  <span class="s">rosconsole</span>
  <span class="s">camera_info_manager</span>
<span class="p">)</span>

<span class="nb">option</span><span class="p">(</span><span class="s">ENABLE_PYTHON</span> <span class="s2">&quot;&quot;</span> <span class="s">ON</span><span class="p">)</span>

<span class="nb">if</span> <span class="p">(</span><span class="s">CMAKE_VERSION</span> <span class="s">VERSION_LESS</span> <span class="s2">&quot;3.1&quot;</span><span class="p">)</span>
  <span class="nb">if</span> <span class="p">(</span><span class="s">CMAKE_COMPILER_IS_GNUCXX</span><span class="p">)</span>
   <span class="nb">execute_process</span><span class="p">(</span><span class="s">COMMAND</span> <span class="s">g++</span> <span class="s">-dumpversion</span> <span class="s">OUTPUT_VARIABLE</span> <span class="s">gxxver</span><span class="p">)</span>

   <span class="nb">if</span> <span class="p">(</span><span class="s">gxxver</span> <span class="s">VERSION_LESS</span> <span class="s2">&quot;4.7&quot;</span><span class="p">)</span>
     <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">&quot;${CMAKE_CXX_FLAGS} -std=c++0x&quot;</span><span class="p">)</span>
   <span class="nb">else</span><span class="p">()</span>
     <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">&quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;</span><span class="p">)</span>
   <span class="nb">endif</span><span class="p">()</span>
  <span class="nb">else</span><span class="p">()</span>
   <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">&quot;${CMAKE_CXX_FLAGS} -std=c++11&quot;</span><span class="p">)</span>
  <span class="nb">endif</span><span class="p">()</span>
<span class="nb">else</span><span class="p">()</span>
  <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">11</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS_DEBUG</span> <span class="s2">&quot;${CMAKE_CXX_FLAGS_DEBUG} -finline-functions&quot;</span><span class="p">)</span>
<span class="nb">option</span><span class="p">(</span><span class="s">ENABLE_GCC_FVISIBILITY_HIDDEN</span> <span class="s2">&quot;Use the -fvisibility=hidden option when the sources are compiled&quot;</span> <span class="s">ON</span><span class="p">)</span>
<span class="nb">option</span><span class="p">(</span><span class="s">ENABLE_INSTALL_RPATH</span> <span class="s2">&quot;Enable RPATH setting for installed binary files&quot;</span> <span class="s">ON</span><span class="p">)</span>

<span class="nb">function</span><span class="p">(</span><span class="s">add_cnoid_plugin</span><span class="p">)</span>

  <span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV</span><span class="o">}</span><span class="p">)</span>

  <span class="nb">if</span><span class="p">(</span><span class="s">ENABLE_GCC_FVISIBILITY_HIDDEN</span><span class="p">)</span>
    <span class="nb">get_target_property</span><span class="p">(</span><span class="s">compile_flags</span> <span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">COMPILE_FLAGS</span><span class="p">)</span>
    <span class="nb">if</span><span class="p">(</span><span class="s">compile_flags</span><span class="p">)</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">COMPILE_FLAGS</span> <span class="s2">&quot;${compile_flags} -fvisibility=hidden&quot;</span><span class="p">)</span>
    <span class="nb">else</span><span class="p">()</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">COMPILE_FLAGS</span> <span class="s2">&quot;-fvisibility=hidden&quot;</span><span class="p">)</span>
    <span class="nb">endif</span><span class="p">()</span>
  <span class="nb">endif</span><span class="p">()</span>

<span class="c">#  set_target_properties(${ARGV0} PROPERTIES</span>
<span class="c">#    LIBRARY_OUTPUT_DIRECTORY ${CNOID_PLUGIN_SUBDIR}</span>
<span class="c">#    ARCHIVE_OUTPUT_DIRECTORY ${CNOID_PLUGIN_SUBDIR}</span>
<span class="c">#    RUNTIME_OUTPUT_DIRECTORY ${CNOID_PLUGIN_SUBDIR})</span>

  <span class="nb">if</span><span class="p">(</span><span class="s">ENABLE_INSTALL_RPATH</span><span class="p">)</span>
    <span class="nb">if</span><span class="p">(</span><span class="s">APPLE</span><span class="p">)</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">INSTALL_NAME_DIR</span> <span class="s2">&quot;@rpath&quot;</span><span class="p">)</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">LINK_FLAGS</span> <span class="s2">&quot;-Wl,-rpath,@loader_path,-rpath,@loader_path/..&quot;</span><span class="p">)</span>
    <span class="nb">else</span><span class="p">()</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">INSTALL_RPATH</span> <span class="s2">&quot;$ORIGIN:$ORIGIN/..&quot;</span><span class="p">)</span>
    <span class="nb">endif</span><span class="p">()</span>
  <span class="nb">else</span><span class="p">()</span>
    <span class="nb">if</span><span class="p">(</span><span class="s">APPLE</span><span class="p">)</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">INSTALL_NAME_DIR</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">else</span><span class="p">()</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span> <span class="s">PROPERTIES</span> <span class="s">INSTALL_RPATH</span> <span class="s2">&quot;$ORIGIN&quot;</span><span class="p">)</span>
    <span class="nb">endif</span><span class="p">()</span>
  <span class="nb">endif</span><span class="p">()</span>

<span class="nb">endfunction</span><span class="p">()</span>

<span class="nb">if</span><span class="p">(</span><span class="s">ENABLE_PYTHON</span><span class="p">)</span>

  <span class="nb">find_package</span><span class="p">(</span><span class="s">PythonLibs</span> <span class="s">2.7</span> <span class="s">REQUIRED</span><span class="p">)</span>
  <span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">PYTHON_INCLUDE_PATH</span><span class="o">}</span><span class="p">)</span>
  <span class="nb">set</span><span class="p">(</span><span class="s">CNOID_PYTHON_SUBDIR</span> <span class="o">${</span><span class="nv">CNOID_PLUGIN_SUBDIR</span><span class="o">}</span><span class="s">/python</span><span class="p">)</span>

  <span class="nb">function</span><span class="p">(</span><span class="s">add_cnoid_python_module</span><span class="p">)</span>
  
    <span class="nb">set</span><span class="p">(</span><span class="s">target</span> <span class="o">${</span><span class="nv">ARGV0</span><span class="o">}</span><span class="p">)</span>
    <span class="nb">string</span><span class="p">(</span><span class="s">REGEX</span> <span class="s">REPLACE</span> <span class="s2">&quot;^Py(.+)$&quot;</span> <span class="s2">&quot;\\1&quot;</span> <span class="s">module</span> <span class="o">${</span><span class="nv">target</span><span class="o">}</span><span class="p">)</span>
    <span class="nb">set</span><span class="p">(</span><span class="s">sources</span> <span class="o">${</span><span class="nv">ARGV</span><span class="o">}</span><span class="p">)</span>
    <span class="nb">list</span><span class="p">(</span><span class="s">REMOVE_AT</span> <span class="s">sources</span> <span class="s">0</span><span class="p">)</span>

    <span class="nb">add_library</span><span class="p">(</span><span class="o">${</span><span class="nv">target</span><span class="o">}</span> <span class="s">SHARED</span> <span class="o">${</span><span class="nv">sources</span><span class="o">}</span><span class="p">)</span>
    
    <span class="nb">if</span><span class="p">(</span><span class="s">NOT</span> <span class="s">WIN32</span><span class="p">)</span>
      <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">target</span><span class="o">}</span>  <span class="s">PROPERTIES</span>
      <span class="s">COMPILE_DEFINITIONS</span> <span class="s2">&quot;BOOST_PYTHON_USE_GCC_SYMBOL_VISIBILITY&quot;</span> <span class="p">)</span>
    <span class="nb">endif</span><span class="p">()</span>

    <span class="nb">set_target_properties</span><span class="p">(</span><span class="o">${</span><span class="nv">target</span><span class="o">}</span>  <span class="s">PROPERTIES</span>
    <span class="c">#  RUNTIME_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/${CNOID_PYTHON_SUBDIR}/cnoid</span>
    <span class="c">#  LIBRARY_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/${CNOID_PYTHON_SUBDIR}/cnoid</span>
      <span class="s">RUNTIME_OUTPUT_NAME</span> <span class="o">${</span><span class="nv">module</span><span class="o">}</span>
      <span class="s">LIBRARY_OUTPUT_NAME</span> <span class="o">${</span><span class="nv">module</span><span class="o">}</span>
      <span class="s">PREFIX</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c">#install(TARGETS ${target}</span>
    <span class="c">#  RUNTIME DESTINATION ${CNOID_PYTHON_SUBDIR}/cnoid CONFIGURATIONS Release Debug RelWithDebInfo MinSizeRel</span>
    <span class="c">#  LIBRARY DESTINATION ${CNOID_PYTHON_SUBDIR}/cnoid CONFIGURATIONS Release Debug RelWithDebInfo MinSizeRel)</span>

  <span class="nb">endfunction</span><span class="p">()</span>


<span class="nb">endif</span><span class="p">()</span>

<span class="c">## Plugins</span>
<span class="nb">add_cnoid_plugin</span><span class="p">(</span><span class="s">CnoidRosBodyPlugin</span>
  <span class="s">SHARED</span>
  <span class="s">src/RosBodyPlugin.cpp</span>
  <span class="s">src/BodyRosItem.cpp</span>
  <span class="s">src/WorldRosItem.cpp</span>
  <span class="s">src/BodyRosJointControllerItem.cpp</span>
  <span class="s">src/BodyRosTorqueControllerItem.cpp</span>
  <span class="s">src/BodyRosHighgainControllerItem.cpp</span>
<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">CnoidRosBodyPlugin</span> <span class="o">${</span><span class="nv">CNOID_LIBRARIES</span><span class="o">}</span> <span class="s">CnoidBodyPlugin</span> <span class="o">${</span><span class="nv">catkin_LIBRARIES</span><span class="o">}</span><span class="p">)</span>

<span class="nb">install</span><span class="p">(</span><span class="s">TARGETS</span> 
  <span class="s">CnoidRosBodyPlugin</span>
  <span class="s">RUNTIME</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CNOID_PLUGIN_SUBDIR</span><span class="o">}</span>
  <span class="s">LIBRARY</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CNOID_PLUGIN_SUBDIR</span><span class="o">}</span>
  <span class="s">ARCHIVE</span> <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CNOID_PLUGIN_SUBDIR</span><span class="o">}</span>
<span class="p">)</span>

<span class="nb">install</span><span class="p">(</span>
  <span class="s">DIRECTORY</span> <span class="s">src/</span>
  <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CATKIN_PACKAGE_INCLUDE_DESTINATION</span><span class="o">}</span>
  <span class="s">USE_SOURCE_PERMISSIONS</span>
  <span class="s">FILES_MATCHING</span> <span class="s">PATTERN</span> <span class="s2">&quot;*.h&quot;</span>
  <span class="s">PATTERN</span> <span class="s2">&quot;choreonoid_plugins&quot;</span> <span class="s">EXCLUDE</span>
  <span class="s">PATTERN</span> <span class="s2">&quot;python&quot;</span> <span class="s">EXCLUDE</span>
<span class="p">)</span>

<span class="nb">install</span><span class="p">(</span>
  <span class="s">DIRECTORY</span> <span class="s">test</span>
  <span class="s">DESTINATION</span> <span class="o">${</span><span class="nv">CATKIN_PACKAGE_SHARE_DESTINATION</span><span class="o">}</span>
  <span class="s">USE_SOURCE_PERMISSIONS</span>
<span class="p">)</span>

<span class="nb">if</span><span class="p">(</span><span class="s">ENABLE_PYTHON</span><span class="p">)</span>
  <span class="nb">add_subdirectory</span><span class="p">(</span><span class="s">src/python</span><span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="tutorial.html" class="btn btn-neutral" title="Choreonoid ROSプラグインチュートリアル" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 - 2017, AIST.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>